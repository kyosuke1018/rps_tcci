<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml">
    <ui:define name="title">#{queryAttachmentController.pageTitle}</ui:define>
    <ui:define name="content">
<f:metadata>
    <f:viewParam name="pagecode" value="#{queryAttachmentController.condVO.pageCode}" />
</f:metadata>
<h:form id="qryForm" prependId="false">        
<p:panel header="#{queryAttachmentController.pageTitle}">
        <p:fieldset id="fieldset_cond" toggleable="true" legend="查詢條件設定">
<!-- 待補 -->
<ui:include src="inc_queryFilter.xhtml"/>
<!-- 待補 -->
            <p:commandButton value="查詢" icon="ui-icon-search"
                 ajax="false" action="#{queryAttachmentController.query()}"
                 update=":qryForm:fieldsetResult"
                 />
            <p:commandButton value="取消" icon="ui-icon-cancel"
                                rendered="false"
                 ajax="false" action="queryAttachment.xhtml"
                 />
            <p:commandButton value="新增" icon="ui-icon-plusthick"
                             rendered="false"
                             onclick="window.open('editAttachment.xhtml')"
            />
        </p:fieldset>    
    <p:fieldset id="fieldsetResult"
                rendered="#{queryAttachmentController.lazyModel != null}"
                legend="查詢結果">
            <h:panelGroup id="pgExp" rendered="#{false}">
                <ui:include src="/include/inc_dataExporter.xhtml">
                    <ui:param name="target" value=":qryForm:dataList"/>
                    <ui:param name="fileName" value="inputk2"/>
                    <ui:param name="rowCount" value="#{queryAttachmentController.lazyModel.rowCount}"/>
                    <ui:param name="controller" value="#{queryAttachmentController}"/>
                </ui:include>   
            </h:panelGroup>
            <h:outputText id="otRowCount" value="(共#{queryAttachmentController.lazyModel.rowCount}筆)" rendered="#{queryAttachmentController.lazyModel!=null}" />
            <br/>
            <p:remoteCommand name="getRowCountAfterFiltered" update=":qryForm:otRowCount" />
            <div style="overflow-x:scroll">
            <p:dataTable id="dataList" var="row" value="#{queryAttachmentController.lazyModel}" lazy="true"
                         styleClass="ui-datatable-hor-scroll"
                         widgetVar="wvDataTable"
                         filteredValue="#{queryAttachmentController.filterResultList}"
                         rows="100" paginator="false" >
                <f:facet name="header">

                </f:facet>
                <!-- filter 後變更筆數, 使用 Lazy Loading 不可直接 update 會抓到上次筆數，故用 oncomplete -->
                <p:ajax event="filter" oncomplete="getRowCountAfterFiltered();" />
                <p:column rendered="false"
                    style="width:50px;text-align: center;"
                    exportable="false"
                >
                    <f:facet name="header">
                        <h:outputLabel  value="動作" escape="false" />
                    </f:facet>
                    <h:link outcome="viewAttachment" target="viewAttachment">
                        <f:param name="id" value="#{row.id}" />
                        <h:graphicImage title="檢視"
                                        library="images" 
                                        name="page_view.png"/>
                    </h:link>
                    <p:spacer width="2"/>
                    <p:commandLink action="#{queryAttachmentController.removeMaster(row)}"
                                   onstart="return confirm('確認要移除這筆明細?')"
                                   update="@form">
                        <h:graphicImage title="移除"
                                        library="images" 
                                        name="page_delete.png"/>
                    </p:commandLink>
                </p:column>
<!-- 待補 -->
<ui:include src="inc_pcolumns.xhtml"/>
<!-- 待補 -->
            </p:dataTable>
            </div>
    </p:fieldset>     
<!--待補-->
<ui:include src="inc_note_query.xhtml">
</ui:include>
<!--待補-->  
</p:panel>
</h:form>    
    </ui:define>
</ui:composition>