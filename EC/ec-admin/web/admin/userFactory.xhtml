<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/template.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{msg['header.app_name']}" />
    </ui:define>
    <ui:define name="head">
        <style  type="text/css">
        </style>
        <script type="text/javascript">
            //<![CDATA[
            function gotoUserMgn(loginAccount){
                var param = "?loginAccount="+loginAccount;
                var url = "#{request.contextPath}/faces/admin/usersMgn.xhtml" + param;
                self.location.href = url;
            }
            //]]>
        </script>
    </ui:define>
    <ui:define name="header">
        <h:outputText value="#{userFactoryController.funcTitle}"/>
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        <!-- 移動查詢結果 -->
        <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
            
        <h:form id="queryForm" prependId="false" rendered="#{!userFactoryController.functionDenied}" >
            <p:messages id="userlistMessage"/>
            <!--使用者工廠權限設定-->
            <p:panel header="#{msg['search.critical']}:" toggleable="true" toggleSpeed="500">
                <!-- BEGIN: 查詢條件 -->
                <p:panelGrid columns="4" layout="grid" columnClasses="ui-grid-col-2,ui-grid-col-4,ui-grid-col-2,ui-grid-col-4">
                    <!-- 帳號 -->
                    <h:outputLabel value="#{msg['usermgmt.label.loginaccount']}:"/>
                    <p:inputText value="#{userFactoryController.filter.loginAccount}"
                                 maxlength="60"/>
                    <!-- 員編 -->
                    <h:outputLabel value="#{msg['usermgmt.label.empid']}:"/>
                    <p:inputText value="#{userFactoryController.filter.empId}"
                                 maxlength="20"/>
                    <!-- 姓名 -->
                    <h:outputLabel value="#{msg['usermgmt.label.cname']}:"/>
                    <p:inputText value="#{userFactoryController.filter.cname}"
                                 maxlength="60"/>
                    <!-- email -->
                    <h:outputLabel value="#{msg['usermgmt.label.email']}:"/>
                    <p:inputText value="#{userFactoryController.filter.email}"
                                 maxlength="60"/>
                    <!-- 廠別 -->                       
                    <h:outputLabel value="#{msg['userfactory.label.factory']}:"/>
                    <!-- 公司別 -->
                    <p:selectOneMenu id="selectCompany" value="#{userFactoryController.filter.company}"  >
                        <f:selectItem itemLabel="--- 選擇公司別 ---" itemValue=""/>
                        <f:selectItems value="#{userFactoryController.companyList}"/>
                        <p:ajax event="change" update="selectFactory" listener="#{userFactoryController.changeCompany}" />
                    </p:selectOneMenu>
                    <!-- 工廠 -->
                    <p:selectOneMenu id="selectFactory" value="#{userFactoryController.filter.factoryId}" >
                        <f:selectItem itemLabel="--- 選擇#{msg['userfactory.label.factory']} ---" itemValue="0"/>
                        <f:selectItems value="#{userFactoryController.factoryList}" />
                    </p:selectOneMenu>
                    <!-- 特殊工廠群組 -->
                    <p:selectOneMenu id="selectFactoryGroup" value="#{userFactoryController.filter.factoryGroupId}" >
                        <f:selectItem itemLabel="--- 選擇特殊工廠群組 ---" itemValue="0" />
                        <f:selectItems value="#{userFactoryController.cmFactorygroupList}" var="item" itemLabel="#{item.groupname}" itemValue="#{item.id}" />
                    </p:selectOneMenu>
                </p:panelGrid>
                
                <h:panelGroup styleClass="blockBtnC" >
                    <!-- END: 查詢條件 -->
                    <p:commandButton value="#{msg['usermgmt.button.query']}"
                                     icon="ui-icon-search"
                                     actionListener="#{userFactoryController.doQuery()}" 
                                     oncomplete="doResize();" 
                                     update="searchResult" />
                    <p:spacer width="5px"/>
                    <!--清除按鈕-->
                    <p:commandButton value="#{msg['common.button.clear']}" 
                                     icon="#{prplanBatchImport.finished?'ui-icon ui-icon-play':'ui-icon ui-icon-cancel'}"  
                                     title="#{msg['common.button.clear']}"
                                     action="#{userFactoryController.reset}" 
                                     update="@form"
                                     />
                </h:panelGroup>
            </p:panel>
                
            <p:panel id="searchResult" header="#{msg['search.result']}:">
                <!-- BEGIN: 查詢結果列表區 -->
                <h:outputText id="otRowCount" value="(共#{userFactoryController.countAfterFilter}筆)" />
                    
                <p:dataTable value="#{userFactoryController.userList}"
                             reflow="true" 
                             var="row" 
                             rows="10" 
                             paginator="true"
                             widgetVar="ufWidgetVar"
                             styleClass="ui-datatable-hor-scroll"
                             filteredValue="#{userFactoryController.filterUserList}"
                             emptyMessage="查無資料"
                             id="dtResult"
                             >
                    <!-- filter 後變更筆數 -->
                    <p:ajax event="filter" listener="#{userFactoryController.onFilter}" update=":queryForm:otRowCount" />
                    <!-- 無法異動 dataTable 內元件
                    <f:facet name="header" >
                        <h:outputText id="otRowCount2" value="(共#{userFactoryController.countAfterFilter}筆)" />
                    </f:facet>
                    -->
                    <p:column style="text-align:center;min-width:40px;" >
                        <f:facet name="header">#{msg['usermgmt.label.action']}</f:facet> 
                        <!-- 編輯 -->　
                        <p:commandLink actionListener="#{userFactoryController.edit(row)}"
                                       update=":editForm:editUserRoleGroup"
                                       oncomplete="PF('editUserRoleDlg').show()"
                                       onstart="afterSuccess();" 
                                       >
                            <h:graphicImage title="#{msg['userfactory.editfactory.title']}"
                                            library="images" 
                                            name="page_edit.png"
                                            style="border-style: none;"/>
                        </p:commandLink>　
                        <p:commandLink process="@none" immediate="true" onclick="gotoUserMgn('#{row.loginAccount}');" >
                            <h:graphicImage title="使用者管理" library="images" name="user.png" style="border-style: none;"/>
                        </p:commandLink>
                    </p:column>                        
                    <!-- 帳號 -->
                    <p:column sortBy="#{row.loginAccount}" filterBy="#{row.loginAccount}" filterMatchMode="contains" filterStyle="width: 60px;" 
                              style="text-align: center;min-width:80px;" >
                        <f:facet name="header">#{msg['usermgmt.label.loginaccount']}</f:facet> 
                        <h:outputText value="#{row.loginAccount}"/>
                    </p:column>
                    <!-- 員編 -->
                    <p:column sortBy="#{row.empId}" filterBy="#{row.empId}" filterMatchMode="contains" filterStyle="width: 60px;" 
                              style="text-align: center;min-width:80px;" >
                        <f:facet name="header">#{msg['usermgmt.label.empid']}</f:facet> 
                        <h:outputText value="#{row.empId}"/>
                    </p:column>
                    <!-- 姓名 -->
                    <p:column sortBy="#{row.cname}" filterBy="#{row.cname}" filterMatchMode="contains" filterStyle="width: 60px;" 
                              style="text-align: center;min-width:80px;" > 
                        <f:facet name="header">#{msg['usermgmt.label.cname']}</f:facet> 
                        <h:outputText value="#{row.cname}"/>
                    </p:column>   
                    <!-- email -->
                    <p:column sortBy="#{row.email}" filterBy="#{row.email}" filterMatchMode="contains" > 
                        <f:facet name="header">#{msg['usermgmt.label.email']}</f:facet> 
                        <h:outputText value="#{row.email}"/>
                    </p:column>
                    <!-- 建立者 -->
                    <p:column sortBy="#{row.creator}" > 
                        <f:facet name="header">#{msg['usermgmt.label.creator']}</f:facet> 
                        <h:outputText value="#{row.creator}"/>
                    </p:column>
                    <!-- 建立時間 -->
                    <p:column sortBy="#{row.createtimestamp}" filterStyle="width: 50px;" > 
                        <f:facet name="header">#{msg['usermgmt.label.createtimestamp']}</f:facet> 
                        <h:outputText value="#{row.createtimestamp}">
                            <f:convertDateTime type="date" pattern="yyyy/MM/dd HH:mm"/>
                        </h:outputText>
                    </p:column>
                    <!-- 工廠 -->
                    <p:column sortBy="#{row.factorys}" filterBy="#{row.factorys}" filterMatchMode="contains"> 
                        <f:facet name="header">#{msg['userfactory.label.factory']}</f:facet> 
                        <p class="wordBreak" style="width:100px" >
                            <h:outputText value="#{row.factorys}"/>
                        </p>
                    </p:column>   
                    <!-- 公司權限 -->
                    <p:column sortBy="#{row.companies}" filterBy="#{row.companies}" filterMatchMode="contains" style="width:100px" >
                        <f:facet name="header">公司權限</f:facet>
                        <p class="wordBreak" style="width:80px" >
                            <h:outputText value="#{row.companies}"/>
                        </p>
                    </p:column>
                    <!-- 工廠群組關連 -->
                    <p:column sortBy="#{row.factoryGroups}" filterBy="#{row.factoryGroups}" filterMatchMode="contains" style="width:100px" >
                        <f:facet name="header">工廠群組關連</f:facet>
                        <p class="wordBreak" style="width:180px" >
                            <h:outputText value="#{row.factoryGroups}"/>
                        </p>
                    </p:column>
                </p:dataTable>
                <!-- END: 查詢結果列表區 -->
            </p:panel>
        </h:form>
        <!-- 廠別權限維護 -->
        <ui:include src="/inc/inc_editUserFactory.xhtml"/>
            
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{userFactoryController}"/>
        </ui:include>
    </ui:define>
</ui:composition>