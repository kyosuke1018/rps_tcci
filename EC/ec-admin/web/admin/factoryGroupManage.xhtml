<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/template.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{msg['header.app_name']}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
            .ui-selectonemenu {
                vertical-align: middle;
            }
        </style>
    </ui:define>
    <ui:define name="header">
        <h:outputText value="#{factoryGroupController.funcTitle}" />
    </ui:define>
    <ui:define name="content">
        <h:form id="cform" prependId="false" rendered="#{!factoryGroupController.functionDenied}">
            <p:messages id="msgAlert"/>
            <p:panel id="plGroup" header="指定群組" toggleable="true">
                <p:panelGrid columns="2" >
                    <h:panelGroup>
                        <!-- 群組類別 -->
                        <p:outputLabel for="somType" value="輸入群組類別：" styleClass="fieldname" />
                        <p:selectOneMenu id="somType" value="#{factoryGroupController.editGroup.grouptype}"
                                         required="true" >
                            <f:selectItems value="#{factoryGroupController.groupTypes}" />
                            <p:ajax event="change" listener="#{factoryGroupController.changeType()}" update="pgEditDelete" />
                        </p:selectOneMenu>
                        <p:spacer width="5px" />
                    </h:panelGroup>
                    <h:panelGroup>
                        <!-- 來源 -->
                        <p:selectOneRadio id="sorGroup" required="true" value="#{factoryGroupController.source}" label="來源：" >
                            <p:ajax update="pgName pgFactory pgDescription somType" listener="#{factoryGroupController.selectSource()}" />
                            <f:selectItem itemLabel="新增群組" itemValue="0" />
                            <f:selectItem itemLabel="現有群組" itemValue="1" />
                        </p:selectOneRadio>
                    </h:panelGroup>
                </p:panelGrid>
                <h:panelGroup id="pgName">
                    <p:spacer width="10px" />
                    <!-- 群組名稱 -->
                    <p:outputLabel for="itGroupName" value="輸入群組名稱：" styleClass="fieldname" rendered="#{factoryGroupController.source==0}" />
                    <p:inputText id="itGroupName" size="20" value="#{factoryGroupController.editGroup.groupname}"
                                 rendered="#{factoryGroupController.source==0}" required="#{factoryGroupController.source==0}" />
                                     
                    <!-- 選取群組 -->
                    <p:outputLabel for="somGroup" value="編輯群組：" styleClass="fieldname" rendered="#{factoryGroupController.source==1}" />
                    <p:selectOneMenu id="somGroup" value="#{factoryGroupController.cmFactorygroupId}" filter="true" filterMatchMode="contains"
                                     onchange="rcSelectGroup();"
                                     rendered="#{factoryGroupController.source==1}"  
                                     required="#{factoryGroupController.source==1}" > 
                        <f:selectItem itemLabel="== 選擇群組 ==" itemValue="0" />
                        <f:selectItems value="#{factoryGroupController.cmFactorygroupList}" var="item" 
                                       itemLabel="#{item.code}-#{item.groupname}" itemValue="#{item.id}"  />
                    </p:selectOneMenu>
                    <p:remoteCommand name="rcSelectGroup" actionListener="#{factoryGroupController.selectGroup()}" 
                                     update="pgFactory pgEditDelete pgDescription somType" />
                    <p:spacer width="10" />
                    <!-- 修改名稱 -->
                    <h:panelGroup id="pgEditDelete" >
                        <h:panelGroup rendered="#{factoryGroupController.source==1}" >
                            <p:outputLabel for="itGroupNameModify" value="新名稱：" />
                            <p:inputText id="itGroupNameModify" size="10" value="#{factoryGroupController.groupNameModify}"
                                         rendered="#{factoryGroupController.source==1}" />
                            <p:watermark for="itGroupNameModify" value="未輸入表不變更" />
                        </h:panelGroup>
                        <p:spacer width="3px" />
                        <p:outputLabel value="代碼：" styleClass="fieldname" />
                        <p:inputText id="itGroupCodeModify" size="4" value="#{factoryGroupController.editGroup.code}" />
                        <p:spacer width="3px" />
                        <p:outputLabel value="排序：" styleClass="fieldname" />
                        <p:inputText size="3" converterMessage="請輸入整數(越小越前面)" 
                                     value="#{factoryGroupController.editGroup.sortnum}" />
                                         
                        <p:spacer width="5" />
                        <p:selectBooleanCheckbox value="#{factoryGroupController.editGroup.disabled}" itemLabel="註記無效" style="vertical-align: middle;" />
                            
                        <p:spacer width="5px" height="18" />
                        <p:commandLink onclick="if (confirm('您確定要刪除此群組!')) { rcDeleteGroup(); }" 
                                       rendered="#{factoryGroupController.canDelete()}" >
                            <h:graphicImage id="itGroupNameDelete" library="images" name="delete.png" 
                                            style="vertical-align: middle; border-style: none" />
                            <h:outputText value="刪除此群組" />
                        </p:commandLink>
                        <p:remoteCommand name="rcDeleteGroup" actionListener="#{factoryGroupController.deleteGroup()}" update="@form" />
                    </h:panelGroup>
                    <br /><p:spacer width="10" height="30" />
                    <!-- 群組說明 -->
                    <h:panelGroup id="pgDescription" >
                        <p:outputLabel for="itDescription" value="輸入群組說明：" styleClass="fieldname" />
                        <p:inputTextarea id="itDescription" style="vertical-align: middle" 
                                         cols="70" rows="1" value="#{factoryGroupController.editGroup.description}" />
                    </h:panelGroup>
                        
                    <h:panelGroup rendered="#{!factoryGroupController.canDelete()}" >
                        <br /><p:spacer width="10" height="20" />
                        <p:outputLabel styleClass="info" value="＊預設群組(由DB直接輸入，ID&lt;100的資料列)及有使用者關聯的群組，不可刪除。" />
                    </h:panelGroup>
                        
                </h:panelGroup>
            </p:panel>
            <!-- BEGIN: 選取工廠 -->
            <p:panel id="plFactorys" header="勾選工廠">
                <div style="width: 100%; min-height: 240px; overflow: auto;">
                    <h:panelGroup id="pgFactory">
                        <table rules="rows" width="100%" >
                            <ui:repeat id="categoryList" var="category" value="#{factoryGroupController.cmFactoryCategoryList}">
                                <tr>
                                    <td  width="140px" class="category" >
                                        <!-- 主廠 -->
                                        <p:selectBooleanCheckbox id="category" immediate="true" value="#{factoryGroupController.categoryCheckMap[category]}" style="vertical-align: middle;" >
                                            <p:ajax immediate="false" listener="#{factoryGroupController.selectCategory(category)}" update="opFactorys"/>
                                        </p:selectBooleanCheckbox>
                                        <p:spacer width="2" />
                                        <h:outputText value="#{category.name}" />
                                    </td>
                                    <td>
                                        <!-- 子廠 -->
                                        <p:outputPanel id="opFactorys" >
                                            <ui:repeat id="factoryList" var="item" value="#{category.cmFactoryList}" varStatus="status">  
                                                <h:outputText value="&nbsp;" />
                                                <p:selectBooleanCheckbox id="factory" value="#{factoryGroupController.factoryCheckMap[item]}" style="vertical-align: middle;" >
                                                </p:selectBooleanCheckbox>
                                                <p:spacer width="2" />
                                                <h:outputText value="#{item.code}(#{item.name})" />       
                                                <p:spacer width="3" height="16" />
                                                <!--每6個換行一次-->
                                                <h:panelGroup rendered="#{(status.index+1) % 6 eq 0}" >
                                                    <br/>
                                                </h:panelGroup>
                                            </ui:repeat>
                                        </p:outputPanel>
                                    </td>   
                                </tr>
                            </ui:repeat>
                        </table>
                    </h:panelGroup><!-- pgFactory --> 
                </div>
                <hr/>
                <h:panelGroup styleClass="blockBtnC">
                    <!-- 確定儲存 -->
                    <p:commandButton id="btnOk"
                                     icon="ui-icon-circle-check"
                                     value="確定"
                                     actionListener="#{factoryGroupController.save()}" 
                                     oncomplete="afterSuccess();" 
                                     update="@form" />
                    <p:spacer width="4" />
                    <!-- 取消 -->
                    <p:commandButton id="btnCancel"
                                     value="取消" type="button"
                                     icon="ui-icon-circle-close" onclick="self.location.reload();"/>
                </h:panelGroup>
            </p:panel>
            <!-- END: 選取工廠 -->
        </h:form>
            
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{factoryGroupController}"/>
        </ui:include>
    </ui:define>
</ui:composition>