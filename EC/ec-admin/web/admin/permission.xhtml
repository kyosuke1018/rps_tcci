<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/template.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{msg['header.app_name']}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
            .pgCol1, .pgCol2 {
                vertical-align: top;
                margin: 0;
                border: #0022aa; 
            }
            .pgCol2 {
                width: 450px;
            }
        </style>
        <script type="text/javascript">
            //<![CDATA[
            //]]>
        </script>
    </ui:define>
    <ui:define name="header">
        <h:outputText value="#{permissionController.funcTitle}" />
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        
        <h:form id="fmMain" prependId="false" rendered="#{!permissionController.functionDenied}" >
            <!-- BEGIN: 查詢條件區 -->
            <p:panel id="plQueryConds" header="#{msg['search.critical']}" collapsed="false" toggleable="true" toggleSpeed="500">
                <p:panelGrid id="pgCriteria" columns="1" >
                    <h:panelGroup >
                        <p:outputLabel value="指定廠別：" styleClass="fieldname"/>
                        <p:selectBooleanCheckbox value="#{permissionController.criteriaVO.selPlant}" >
                            <p:ajax listener="#{permissionController.changeSelPlant()}" update="pgCriteria" /> 
                        </p:selectBooleanCheckbox>
                        <p:spacer width="5" />
                        <!-- SAP CLIENT -->
                        <p:selectOneMenu value="#{permissionController.criteriaVO.sapClientCode}" disabled="#{!permissionController.criteriaVO.selPlant}" >
                            <f:selectItems value="#{permissionController.sapClientOps}" />
                            <p:ajax event="change" update="pgCriteria" listener="#{permissionController.changeSapClient()}" />
                        </p:selectOneMenu>
                        
                        <!-- 公司別
                        <p:spacer width="2" />
                        <p:selectOneMenu value="#{permissionController.criteriaVO.company}" disabled="#{!permissionController.criteriaVO.selPlant}" >
                            <f:selectItems value="#{permissionController.companyOps}" />
                            <p:ajax event="change" update="pgCriteria" listener="#{permissionController.changeCompany()}" />
                        </p:selectOneMenu>
                        -->
                        
                        <!-- 廠別 -->
                        <p:spacer width="2" />
                        <p:selectOneMenu value="#{permissionController.criteriaVO.plant}" disabled="#{!permissionController.criteriaVO.selPlant}" >
                            <f:selectItems value="#{permissionController.plantOps}" />
                        </p:selectOneMenu>
                        
                        <p:spacer width="10" />
                        <p:outputLabel value="包含台訊人員：" styleClass="fieldname"/>
                        <p:selectBooleanCheckbox value="#{permissionController.criteriaVO.includeTCCI}" />
                        
                        <br/><p:spacer width="5" height="2" /><br/>
                        <p:outputLabel value="關鍵字：" styleClass="fieldname"/>
                        <p:inputText id="itKeyword" maxlength="30" size="20" value="#{permissionController.criteriaVO.keyword}" />
                        <p:watermark for="itKeyword" value="輸入帳號或姓名關鍵字" />
                        
                        <p:spacer width="10" />
                        <p:outputLabel value="呈現方式：" title="查詢結果呈現方式" styleClass="fieldname"/>
                        <p:selectOneMenu id="somResult" value="#{permissionController.criteriaVO.rptType}" >
                            <f:selectItems value="#{permissionController.rptTypeOps}" />
                        </p:selectOneMenu>
                        <p:spacer width="10" />
                        <p:outputLabel value="只顯示有權限的資料：" styleClass="fieldname"/>
                        <p:selectBooleanCheckbox value="#{permissionController.criteriaVO.allowOnly}" />
                    </h:panelGroup>
                </p:panelGrid>
                
                <p:separator /> 
                <h:panelGroup styleClass="blockBtnC">
                    <p:spacer width="10" height="20" />
                    <!--確定按鈕-->
                    <p:commandButton value="#{msg['button.search']}" icon="ui-icon-search"
                                     actionListener="#{permissionController.doQuery()}"
                                     update="plResult"/>
                    <p:spacer width="5px"/>
                    <!--清除按鈕-->
                    <p:commandButton value="#{msg['common.button.clear']}" icon="ui-icon ui-icon-cancel"
                                     actionListener="#{permissionController.doReset()}" 
                                     oncomplete="doResize();" 
                                     update="plQueryConds plResult"
                                     />
                    <p:spacer width="5px"/>
                    <!--
                    <h:outputText value="(因資料過多，請至少輸入[廠別]、[當責單位]或[關鍵字]其中一條件)" class="info" />
                    -->
                </h:panelGroup>
            </p:panel>
            <!-- END 查詢條件區 -->
            
            <!-- 移動查詢結果 -->
            <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
            
            <!-- BEGIN: 查詢結果列表區 -->
            <p:panel id="plResult" header="#{msg['search.result']}">
                <!-- 依使用者為主 -->
                <h:panelGroup rendered="#{permissionController.criteriaVO.rptType eq 'USER'}" >
                    <script type="text/javascript">
                        activeDataTableID = "dtResult";
                        doResize();
                    </script>
                    <h:panelGroup id="pgRoeCount" >
                        <h:outputText id="otRowCount" value="(共#{permissionController.resultList.size()}筆)" 
                                      rendered="#{!empty permissionController.resultList and empty permissionController.filterResultList}" />
                        <h:outputText id="otRowCount2" value="(共#{permissionController.filterResultList.size()}筆)" 
                                      rendered="#{!empty permissionController.filterResultList}" />
                    </h:panelGroup>
                    <p:remoteCommand name="rcGetRowCountAfterFiltered" update=":fmMain:pgRoeCount" />
                    
                    <!-- 查詢結果匯出 -->
                    <h:panelGroup id="pgExp" rendered="#{!empty permissionController.resultList}" >
                        <ui:include src="/inc/inc_dataExporter.xhtml">
                            <ui:param name="target" value=":fmMain:dtResult"/>
                            <ui:param name="fileName" value="Permission"/>
                            <ui:param name="rowCount" value="#{permissionController.resultList.size()}"/>
                            <ui:param name="controller" value="#{permissionController}"/>
                        </ui:include>
                    </h:panelGroup>
                    
                    <!--  查詢結果 -->
                    <p:dataTable id="dtResult" var="row" 
                                 value="#{permissionController.resultList}"
                                 widgetVar="wvDTResult"
                                 filteredValue="#{permissionController.filterResultList}"
                                 styleClass="ui-datatable-hor-scroll"
                                 rows="10"
                                 paginator="true" >
                        <!-- filter 後變更筆數, 使用 Lazy Loading 不可直接 update 會抓到上次筆數，故用 oncomplete -->
                        <p:ajax event="filter" oncomplete="doResize(); rcGetRowCountAfterFiltered();" /><!-- 調整寬度 for chrome -->
                        
                        <p:column sortBy="#{row.loginAccount}" filterBy="#{row.loginAccount}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="帳號" />
                            </f:facet>
                            <h:outputText value="#{row.loginAccount}" />
                        </p:column>
                        <p:column sortBy="#{row.cname}" filterBy="#{row.cname}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="姓名" />
                            </f:facet>
                            <h:outputText value="#{row.cname}" />
                        </p:column>
                        <p:column sortBy="#{row.plants}" filterBy="#{row.plants}" filterMatchMode="contains" filterStyle="width:140px" >
                            <f:facet name="header" >
                                <h:outputLabel value="廠別(含公司別設定)" />
                            </f:facet>
                            <p class="wordBreak" style="max-width:440px;min-width:100px;"><h:outputText value="#{row.plants}" /></p>
                        </p:column>
                        <p:column sortBy="#{row.groups}" filterBy="#{row.groups}" filterMatchMode="contains" filterStyle="width:180px" >
                            <f:facet name="header" >
                                <h:outputLabel value="系統角色" />
                            </f:facet>
                            <p class="wordBreak" style="max-width:440px;min-width:100px;"><h:outputText value="#{row.groups}" /></p>
                        </p:column>
                    </p:dataTable>
                    
                </h:panelGroup>
                
                <!-- 依廠別為主 -->
                <h:panelGroup  rendered="#{permissionController.criteriaVO.rptType eq 'PLANT'}" >
                    <script type="text/javascript">
                        activeDataTableID = "dtResultPlant";
                        doResize();
                    </script>
                    
                    <h:panelGroup id="pgRoeCountP" >
                        <h:outputText id="otRowCountP" value="(共#{permissionController.resultPlantList.size()}筆)" 
                                      rendered="#{!empty permissionController.resultPlantList and empty permissionController.filterResultPlantList}" />
                        <h:outputText id="otRowCountP2" value="(共#{permissionController.filterResultPlantList.size()}筆)" 
                                      rendered="#{!empty permissionController.filterResultPlantList}" />
                    </h:panelGroup>
                    <p:remoteCommand name="rcGetRowCountAfterFilteredP" update=":fmMain:pgRoeCountP" />
                    
                    <!-- 查詢結果匯出 -->
                    <h:panelGroup id="pgExpP" rendered="#{!empty permissionController.resultPlantList}" >
                        <ui:include src="/inc/inc_dataExporter.xhtml">
                            <ui:param name="target" value=":fmMain:dtResultPlant"/>
                            <ui:param name="fileName" value="Permission"/>
                            <ui:param name="rowCount" value="#{permissionController.resultPlantList.size()}"/>
                            <ui:param name="controller" value="#{permissionController}"/>
                        </ui:include>
                    </h:panelGroup>
                    
                    <!--  查詢結果 -->
                    <p:dataTable id="dtResultPlant" var="row" 
                                 value="#{permissionController.resultPlantList}"
                                 widgetVar="wvDTResultP"
                                 filteredValue="#{permissionController.filterResultPlantList}"
                                 styleClass="ui-datatable-hor-scroll"
                                 rows="10"
                                 paginator="true" >
                        <!-- filter 後變更筆數, 使用 Lazy Loading 不可直接 update 會抓到上次筆數，故用 oncomplete -->
                        <p:ajax event="filter" oncomplete="doResize(); rcGetRowCountAfterFilteredP();" /><!-- 調整寬度 for chrome -->
                        <p:column sortBy="#{row.plantCode}" filterBy="#{row.plantCode}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="廠別代號" />
                            </f:facet>
                            <h:outputText value="#{row.plantCode}" />
                        </p:column>
                        <p:column sortBy="#{row.plantName}" filterBy="#{row.plantName}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="廠別名稱" />
                            </f:facet>
                            <h:outputText value="#{row.plantName}" />
                        </p:column>
                        <p:column sortBy="#{row.loginAccount}" filterBy="#{row.loginAccount}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="帳號" />
                            </f:facet>
                            <h:outputText value="#{row.loginAccount}" />
                        </p:column>
                        <p:column sortBy="#{row.cname}" filterBy="#{row.cname}" filterMatchMode="contains" filterStyle="width:100px" style="text-align: center">  
                            <f:facet name="header" >
                                <h:outputLabel value="姓名" />
                            </f:facet>
                            <h:outputText value="#{row.cname}" />
                        </p:column>
                        <p:column sortBy="#{row.groups}" filterBy="#{row.groups}" filterMatchMode="contains" filterStyle="width:180px" >
                            <f:facet name="header" >
                                <h:outputLabel value="系統角色" />
                            </f:facet>
                            <p class="wordBreak" style="max-width:640px;min-width:100px;"><h:outputText value="#{row.groups}" /></p>
                        </p:column>
                    </p:dataTable>
                    
                </h:panelGroup>
                
            </p:panel>
            <!-- END: 查詢結果列表區 -->
        </h:form>
        
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{permissionController}"/>
        </ui:include>
        
    </ui:define>
</ui:composition>
