<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml">
    <ui:define name="title">#{articleEdit.pageTitle}</ui:define>
    <ui:define name="head">
        <script src="/storeadmin/tinymce/tinymce.min.js"></script>
        <style>
            #wrapper.useEditor #useLink {display: none;}
            #wrapper.useEditor #useEditor {display: block;}
            #wrapper #useEditor {display: none;}
        </style>
    </ui:define>
    <ui:define name="content">
        <p:panel header="#{articleEdit.pageTitle}">
            <h:form id="form" prependId="false">
                <h:panelGrid columns="2">
                    <h:outputLabel value="主旨: "/>
                    <p:inputText id="selected_title" value="#{articleEdit.selected.title}" size="120" maxlength="255" onblur="trimInput(this)"/>
                    <h:outputLabel value="格式: "/>
                    <h:selectOneRadio value="#{articleEdit.useContent}" onchange="radioChange(this);">
                        <f:selectItem itemLabel="自訂連結" itemValue="#{false}"/>
                        <f:selectItem itemLabel="自訂內容" itemValue="#{true}"/>
                    </h:selectOneRadio>
                </h:panelGrid>
                <hr/>
                <div id="wrapper" class="#{articleEdit.useContent ? 'useEditor' : ''}">
                    <div id="useLink">
                        <h:outputLabel value="網址: "/>
                        <p:inputText value="#{articleEdit.selected.link}" size="120" maxlength="255" onblur="trimInput(this)"/>
                    </div>
                    <div id="useEditor">
                        <h:inputTextarea id="mytextarea" value="#{articleEdit.selected.content}"/>
                    </div>
                </div>
                <hr/>
                <p:button value="取消"
                          icon="ui-icon-circle-close"
                          outcome="list.xhtml"/>&nbsp;
                <p:commandButton value="儲存"
                                 icon="ui-icon-disk"
                                 action="#{articleEdit.save}"
                                 onstart="return preSave();"/>&nbsp;
                <p:commandButton value="儲存並發佈"
                                 icon="ui-icon-circle-arrow-e"
                                 action="#{articleEdit.saveAndPublish}"
                                 onstart="return preSave();"
                                 rendered="#{empty articleEdit.selected.pubdate}"/>
            </h:form>
        </p:panel>            
        <script>
            $(document).ready(function () {
                tinymce.init({
                    selector: '#mytextarea',
                    relative_urls: false,
                    height: "250",
                    file_picker_callback: elFinderBrowser,
                    language: 'zh_TW',
                    plugins: [
                        'advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker',
                        'searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking',
                        'save table contextmenu directionality emoticons template paste textcolor'
                    ]
                });
            });
            function radioChange(element) {
                if ($(element).val() === 'true') {
                    $('#wrapper').addClass('useEditor');
                } else {
                    $('#wrapper').removeClass('useEditor');
                }
            }
            function preSave() {
                if ($('#selected_title').val() === '') {
                    alert('主旨不能為空白!');
                    $('#selected_title').focus();
                    return false;
                }
                $('#mytextarea').value(tinyMCE.get('mytextarea').getContent());
                return true;
            }
            function elFinderBrowser(callback, value, meta) {
                tinymce.activeEditor.windowManager.open({
                    file: '/storeadmin/elfinder/index.html', // use an absolute path!
                    title: '台泥電商檔案管理系統',
                    width: 950,
                    height: 450,
                    resizable: 'yes'
                }, {
                    oninsert: function (file, elf) {
                        var url, reg, info;

                        // URL normalization
                        url = file.url;
                        reg = /\/[^/]+?\/\.\.\//;
                        while (url.match(reg)) {
                            url = url.replace(reg, '/');
                        }
                        // replace /storeadmin/ -> /tccstore
                        url = url.replace(/^\/storeadmin\//, '/tccstore/');

                        // Make file info
                        info = file.name + ' (' + elf.formatSize(file.size) + ')';

                        // Provide file and text for the link dialog
                        if (meta.filetype == 'file') {
                            callback(url, {text: info, title: info});
                        }

                        // Provide image and alt text for the image dialog
                        if (meta.filetype == 'image') {
                            callback(url, {alt: info});
                        }

                        // Provide alternative source and posted for the media dialog
                        if (meta.filetype == 'media') {
                            callback(url);
                        }
                    }
                });
                return false;
            }
        </script>
    </ui:define>
</ui:composition>