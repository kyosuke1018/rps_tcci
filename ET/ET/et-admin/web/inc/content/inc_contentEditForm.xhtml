<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                >
    <!-- 編輯區塊 -->
    <h:form id="contentEditForm" prependId="false" enctype="multipart/form-data">
        <h:panelGroup id="pgEditDetail" >
            <p:fieldset legend="編輯#{doctype}" rendered="#{publication.showDetail}" toggleable="true" >
                <p:panelGrid columns="5" >
                    <p:outputLabel value="資料類型：" styleClass="fieldname required" />
                    <p:outputLabel value="#{publication.editVO.dataTypeName}" styleClass="info"
                                   rendered="#{publication.editVO.type ne ui.tempCode}" ></p:outputLabel>
                                       
                    <h:panelGroup rendered="#{publication.editVO.type eq ui.tempCode}" >
                        <input type="text" id="dataTypeORI" name="dataTypeORI" style="display:none;" 
                               value="#{publication.editVO.dataType}" />
                        <p:selectOneRadio id="sorDataType" onclick="return changeDataType(this);" 
                                          value="#{publication.editVO.dataType}" >
                            <p:ajax event="change" listener="#{publication.changeDataType()}"
                                    update=":contentEditForm:pgEditDetailByType :contentEditForm:pgEditDetailBtn :contentEditForm:pgStatus" />
                            <f:selectItems value="#{ui.dataTypeOptions}" />
                        </p:selectOneRadio>
                    </h:panelGroup>
                        
                    <h:panelGroup >
                        <p:outputLabel value="歸屬資料夾：" styleClass="fieldname" />
                        <p:selectOneMenu value="#{publication.editVO.parent}" >
                            <f:selectItem itemLabel="==" noSelectionOption="true" />
                            <f:selectItems value="#{publication.folders}" 
                                           var="vo" itemValue="#{vo.id}" itemLabel="#{vo.title}" ></f:selectItems>
                        </p:selectOneMenu>
                    </h:panelGroup>
                        
                    <h:panelGroup>
                        <p:outputLabel value="網站語系：" styleClass="fieldname" />
                        <p:selectOneMenu value="#{publication.editVO.lang}" >
                            <f:selectItems value="#{ui.langWebSiteOptions}" ></f:selectItems>
                        </p:selectOneMenu>
                    </h:panelGroup>
                        
                    <h:panelGroup id="pgCoverImg" rendered="#{publication.hasCoverImage()}" >
                        <h:panelGrid columns="4" cellpadding="5" >
                            <p:outputLabel value="封面圖示：" styleClass="fieldname" />
                            <p:fileUpload fileUploadListener="#{publication.uploadCoverImage}" 
                                          allowTypes="/(\.|\/)(gif|jpe?g|png)$/" 
                                          update=":contentEditForm:pgUploadCover" 
                                          multiple="false" 
                                          auto="true" 
                                          invalidFileMessage="不支援的檔案格式"
                                          invalidSizeMessage="檔案大小超過限制"
                                          label="選取檔案" cancelLabel="取消" uploadLabel="上傳檔案" />
                                              
                            <h:panelGroup id="pgUploadCover" >
                                <p:spacer width="5" height="5" />
                                <p:outputLabel rendered="#{publication.uploadCoverImage}" value="#{publication.editVO.coverImg}" styleClass="info" />
                                <!-- 封面預覽 -->
                                <p:lightBox rendered="#{publication.showCoverImage()}" id="lighbox1">  
                                    <h:outputLink value="#{imageController.genImageUrl(publication.editVO.coverImgVO, true, true)}&amp;imgType=S" >  
                                        <h:graphicImage url="#{imageController.getImageSrc(publication.editVO.coverImgVO)}&amp;imgType=S" 
                                                        title="#{publication.editVO.coverImg}" 
                                                        style="max-height: 60px; max-width: 120px" />
                                    </h:outputLink>
                                </p:lightBox>
                                <p:spacer width="10" height="5"/>
                            </h:panelGroup>
                                
                            <p:commandLink title="刪除封面圖示" 
                                           actionListener="#{publication.deleteCoverImg(publication.editVO.coverImgVO)}"
                                           update="pgCoverImg"
                                           onclick="if( !confirm('您確定要刪除封面圖示嗎?\n(只處按[確定]即刪除封面圖示，不論後續是否按[儲存]。)') ){ return false; }" 
                                           oncomplete="afterCallBackHandler(xhr, status, args);"
                                           rendered="#{publication.canDelCoverImage()}" >
                                <h:graphicImage library="images" name="delete.png" styleClass="icons" />
                            </p:commandLink>
                        </h:panelGrid>
                    </h:panelGroup>
                </p:panelGrid>
                    
                <p:panelGrid columns="2" >
                    <p:outputLabel value="標題：" styleClass="fieldname required" />
                    <p:inputText id="itTitle" size="100" value="#{publication.editVO.title}" />
                        
                    <p:outputLabel value="內容大綱：" styleClass="fieldname" />
                    <p:inputTextarea id="itSummary" cols="100" rows="3" value="#{publication.editVO.summary}" />
                        
                    <p:outputLabel value="發佈日期：" styleClass="fieldname required" />
                    <h:panelGroup id="pgStatus" >
                        <p:calendar  showOn="button" size="10" maxlength="10" readonlyInput="false" navigator="true"
                                     value="#{publication.editVO.dataDate}" 
                                     converterMessage="日期格式錯誤(yyyy/MM/dd)" 
                                     pattern="yyyy/MM/dd" />
                                         
                        <!-- 固定網頁只有系統管理人員可新增與變更編號 -->
                        <p:spacer width="5" height="5" />
                        <p:outputLabel value="編號：" styleClass="fieldname" />
                        <p:inputText size="10"
                                     styleClass="#{publication.canAddDoc()?'':'readonly'}"
                                     readonly="#{!publication.canAddDoc()}" 
                                     value="#{publication.editVO.code}" />
                                         
                        <h:panelGroup rendered="#{(publication.editVO.type ne 'F') or (tcSessionController.administrator)}">
                            <p:spacer width="5" height="5" />
                            <p:outputLabel value="狀態：" styleClass="fieldname required" />
                            <p:selectOneMenu value="#{publication.editVO.status}" >
                                <f:selectItems value="#{ui.contentStatusOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                            <!--
                            <p:spacer width="5" height="5" />
                            <p:selectBooleanCheckbox itemLabel="加入最新消息" 
                                                     value="#{publication.editVO.news}" /> 
                            -->
                        </h:panelGroup>
                            
                        <h:panelGroup rendered="#{publication.editVO.dataType eq ui.htmlCode}" >
                            <p:spacer width="10" height="5" />
                            <p:commandButton id="cbContentEditSave2" value="儲存" 
                                             onstart="return preSave();"
                                             rendered="#{!publication.readOnly}" 
                                             actionListener="#{publication.saveDoc()}" 
                                             update=":contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                             oncomplete="afterCallBackHandler(xhr, status, args);" 
                                             icon="ui-icon-disk" ></p:commandButton><!-- update all form -->
                            <p:spacer width="5" />
                            <p:commandButton id="cbContentEditClose2" value="關閉(回查詢頁)"
                                             actionListener="#{publication.closeDocDetail()}" 
                                             update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                             oncomplete="hideDocDetailArea(xhr, status, args);"
                                             onclick="return confirmClose();"
                                             icon="ui-icon-circle-close" ></p:commandButton>
                        </h:panelGroup>
                    </h:panelGroup>    
                </p:panelGrid>
            </p:fieldset>
                
            <!-- 依文件類型區分的編輯區 -->
            <h:panelGroup id="pgEditDetailByType" >
                <!-- 連結 -->
                <p:panel id="plLink" rendered="#{publication.showDetail and publication.editVO.dataType eq 'L'}" >
                    <p:panelGrid columns="2" >
                        <p:outputLabel value="連結網址：" styleClass="fieldname required" />
                        <p:panelGrid columns="2" >
                            <p:inputText size="80" value="#{publication.editVO.url}" />
                            <p:link rendered="#{!empty publication.editVO.url}"
                                    href="#{publication.editVO.url}" 
                                    target="#{(publication.editVO.openMethod eq 'N')?'_blank':'_self'}" >
                                <h:graphicImage library="images" name="link_go.png" styleClass="icons" />
                            </p:link>
                        </p:panelGrid>
                            
                        <p:outputLabel value="開啟方式：" styleClass="fieldname required" />
                        <p:selectOneRadio value="#{publication.editVO.openMethod}" >
                            <f:selectItem itemLabel="原視窗開啟" itemValue="O" />
                            <f:selectItem itemLabel="新視窗開啟" itemValue="N" />
                                
                            <p:ajax event="change" 
                                    update="plLink" 
                                    process="plLink" 
                                    listener="#{publication.changeOpenMethod()}" />
                        </p:selectOneRadio>
                    </p:panelGrid>
                </p:panel>
                    
                <!-- 上傳檔案 -->
                <p:panel id="plUploadFiles" rendered="#{publication.showDetail and publication.editVO.dataType eq ui.uploadCode}" >
                    <p:outputLabel value="上傳文件檔案：" styleClass="fieldname required" />
                    <p:spacer width="10" height="5" />
                    <p:outputLabel value="(一次最多選取10個檔案，每個檔案不可超過10MB。)" styleClass="info" />
                    <br/>
                        
                    <h:panelGroup styleClass="pgdFile" rendered="#{!publication.readOnly}" >
                        <div style="max-height:300px; max-width: 600px; overflow-y: auto;" >
                            <p:fileUpload fileUploadListener="#{file.handleFileUpload}" 
                                          update="plUploadFiles" 
                                          multiple="true" fileLimit="10" 
                                          allowTypes="/(\.|\/)(pdf|doc|docx|ppt|pptx|xls|xlsx)$/"
                                          fileLimitMessage="一次最多上傳10個檔案"
                                          invalidFileMessage="不支援的檔案格式"
                                          invalidSizeMessage="檔案大小超過限制"
                                          label="選取檔案" cancelLabel="取消" uploadLabel="上傳檔案" />
                        </div>
                        <p:outputLabel rendered="#{!empty file.files}"
                                       value="已上傳#{file.files.size()}個檔案，請記得確認[儲存]。" styleClass="info" />
                    </h:panelGroup>
                    <p:panelGrid columns="2" rendered="#{!empty publication.editVO.docs}" >
                        <p:outputLabel value="已儲存檔案：" styleClass="fieldname" />
                        <h:panelGroup id="pgUploadFiles" >
                            <ui:repeat var="doc" value="#{publication.editVO.docs}" varStatus="status">
                                <p:outputLabel value="#{doc.fileName}" />
                                <h:commandLink title="下載" actionListener="#{file.fetchDocFile(doc)}" >
                                    <h:graphicImage library="images" name="download.png" styleClass="icons" />
                                    <p:fileDownload value="#{file.downloadFile}" />
                                </h:commandLink>
                                <p:spacer width="2" height="5"/>
                                <p:commandLink title="刪除" 
                                               actionListener="#{publication.deleteFile(doc)}"
                                               update=":contentEditForm:plUploadFiles"
                                               onclick="if( !confirm('您確定要刪除嗎?') ){ return false; }" 
                                               oncomplete="afterCallBackHandler(xhr, status, args);"
                                               rendered="#{(!publication.readOnly) and (!empty doc.applicationdata)}" >
                                    <h:graphicImage library="images" name="delete.png" styleClass="icons" />
                                </p:commandLink>
                                <p:spacer width="10" height="5"/>
                            </ui:repeat>
                        </h:panelGroup>
                    </p:panelGrid>
                </p:panel>            
            </h:panelGroup>
        </h:panelGroup>
            
        <!-- TinyMCE 部分不可用 rendered，需用JS控制 -->
        <h:panelGroup id="pgEditTinyMCE" >
            <!-- 自製網頁 -->
            <div id="wrapper" style="height:0px; overflow-y:hidden;" >
                <p:panel>
                    <p:outputLabel value="自製網頁內容：" styleClass="fieldname required" />
                    <p:spacer width="10" height="10" />
                    <!-- 預覽需同時執行 servics、 web -->
                    <p:commandButton value="網站模擬預覽" 
                                     onstart="return preSave();" 
                                     actionListener="#{publication.webPreview()}" 
                                     oncomplete="openPreviewWin(xhr, status, args);"
                                     icon="ui-icon-circle-zoomout" 
                                     />
                    <p:spacer width="5" height="10" />
                    <p:outputLabel value="(注意：預覽時，建議可同時縮小瀏覽器寬度，檢視頁面在手機螢幕大小顯示狀況是否正常。)" styleClass="info" />
                    <br/>
                    <p:spacer width="5" height="5" />
                    <br/>
                    <h:inputTextarea id="mytextarea" value="#{publication.editVO.contents}" />
                    
                    <p:fieldset legend="使用說明：" >
                        <h:graphicImage library="images" name="info.png" styleClass="icons" />
                        <h:outputText value="要編輯已插入的圖片，請於該圖片上按住滑鼠左鍵，稍微滑動滑鼠，使圖片呈現選取狀態後，即可進行圖片編輯。" /><br/>
                    </p:fieldset>
                </p:panel>
            </div>
        </h:panelGroup>
            
        <h:panelGroup id="pgEditDetailBtn" >
            <!-- BEGIN: 隱藏欄位 for TinyMCE -->
            <textArea id="hiddenContents" style="display: none" rows="5" cols="60" ><h:outputText value="#{publication.editVO.contents}" /></textArea>
            <input id="hiddenEditId" type="text" style="display: none;" value="#{publication.editVO.id}" />
            <!-- BEGIN: 隱藏欄位 for TinyMCE -->
                
            <p:panelGrid columns="1" styleClass="pgDlgActionBtns" >
                <h:panelGroup id="pgContentEditSubmit"
                              rendered="#{publication.showDetail}" >
                    <p:commandButton id="cbContentEditSave" value="儲存" 
                                     rendered="#{!publication.readOnly}" 
                                     onstart="return preSave();"
                                     actionListener="#{publication.saveDoc()}" 
                                     update=":contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                     oncomplete="afterCallBackHandler(xhr, status, args);" 
                                     icon="ui-icon-disk" ></p:commandButton><!-- update all form -->
                    <p:spacer width="5" />
                    <p:commandButton id="cbContentEditClose" value="關閉(回查詢頁)" immediate="true" 
                                     actionListener="#{publication.closeDocDetail()}" 
                                     update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                     oncomplete="hideDocDetailArea(xhr, status, args);"
                                     onclick="hideTinyMCE();" 
                                     icon="ui-icon-circle-close" ></p:commandButton>
                </h:panelGroup>
            </p:panelGrid>            
        </h:panelGroup>
    </h:form>
        
    <script src="#{request.contextPath}/tinymce/tinymce.min.js"></script>
    <script type="text/javascript">
        //<![CDATA[
        // TinyMCE custom dialog page url
        var SELECT_IMG_DLG_URL = "photosSelect.xhtml?docId=";// 插入圖庫選取圖片功能
        var SELECT_VIDEO_DLG_URL = "videosSelect.xhtml?docId=";// 插入影片庫選取影片功能
        var UPLOAD_IMG_DLG_URL = "tinymceDlg.xhtml?type=#{ui.uploadImageCode}&id=";// 插入即時上傳圖片功能
        var UPLOAD_DOC_DLG_URL = "tinymceDlg.xhtml?type=#{ui.uploadDocCode}&id=";// 插入即時上傳文件功能
        var UPLOAD_VIDEO_DLG_URL = "tinymceDlg.xhtml?type=#{ui.uploadVideoCode}&id=";// 插入即時上傳影片功能
        var WEB_PREVIEW_URL = "#{publication.webPreviewPage}"; // 預覽網頁
        // TinyMCE custom button icons
        var ICON_IMG_UPLOAD = "/csrcweb/tinymce/icons/picture_add.png";// 插入即時上傳圖片功能
        var ICON_DOC_UPLOAD = "/csrcweb/tinymce/icons/page_add.png";// 插入即時上傳文件功能
        var ICON_VIDEO_UPLOAD = "/csrcweb/tinymce/icons/film_add.png";// 插入即時上傳影片功能
        
        /**
         * inti TinyMCE
         * @returns 
         */
        function initTinyMCE(){
            tinymce.init({
                selector: '#mytextarea',
                relative_urls: false,
                allow_script_urls: false,
                remove_script_host: false,
                height: "400",
                file_picker_callback: filePicker,
                toolbar: "insertfile undo redo"
                        +"| table "
                        +"| fontsizeselect "
                        +"| bold italic forecolor backcolor "
                        +"| uploadimage uploadvideo uploaddoc | image media link "
                        +"| bullist numlist outdent indent "
                        +"| alignleft aligncenter alignright alignjustify "
                        +"| preview", // fullpage print",
                plugins: [
                    "advlist autolink link image lists charmap print preview hr anchor pagebreak spellchecker",
                    "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking",
                    "save table contextmenu directionality emoticons template paste textcolor colorpicker",
                    "textpattern imagetools" // fullpage
                ],
                content_style: '.mce-resize-bar {background-color: blue; opacity: 0.5;}',
                add_unload_trigger: true,
                image_advtab: true,
                language: 'zh_TW',
                setup: function(editor) {
                    // 開啟上傳對話框
                    function openUploadFileDlg(urlPrefix, title, width, height){
                        var editId = $('#hiddenEditId').val();
                        var url = urlPrefix + editId;
                        
                        tinymce.activeEditor.windowManager.open({
                            file: url, // use an absolute path!
                            title: title,
                            width: width,
                            height: height,
                            resizable: 'yes'
                        },{
                            onupload: function (html){// 將回傳HTML插入游標處
                                editor.insertContent(html);
                            }
                        });
                    }
                    // 自訂插入即時上傳圖片功能
                    function openUploadImageDlg() {
                        openUploadFileDlg(UPLOAD_IMG_DLG_URL, '直接插入上傳圖片', 500, 100);
                    }
                    
                    editor.addButton('uploadimage', {
                        icon: false,
                        image: ICON_IMG_UPLOAD,
                        tooltip: "直接插入上傳圖片",
                        onclick: openUploadImageDlg
                    });
                    
                    // 自訂插入即時上傳文件功能            
                    function openUploadDocDlg() {
                        openUploadFileDlg(UPLOAD_DOC_DLG_URL, '直接插入上傳文件', 500, 300);
                    }
                    
                    editor.addButton('uploaddoc', {
                        icon: false,
                        image: ICON_DOC_UPLOAD,
                        tooltip: "直接插入上傳文件",
                        onclick: openUploadDocDlg
                    });
                    
                    // 自訂插入即時上傳影片功能            
                    function openUploadVideoDlg() {
                        openUploadFileDlg(UPLOAD_VIDEO_DLG_URL, '直接插入Youtube上傳影片', 500, 180);
                    }
                    editor.addButton('uploadvideo', {
                        icon: false,
                        image: ICON_VIDEO_UPLOAD,
                        tooltip: "直接插入Youtube上傳影片",
                        onclick: openUploadVideoDlg
                    });
                }
            });
        }
        
        /**
         * Call Back Function for TinyMCE Plugin
         * @param {type} callback
         * @param {type} value
         * @param {type} meta
         * @returns {undefined|Boolean}
         */
        function filePicker(callback, value, meta) {
            //alert(callback);
            //alert(value);
            //alert(meta);
            if( meta.filetype === 'file' ){
                alert("請於[網址]欄輸入完整連結網址。(含http:// 或 https://)");
                // callback('mypage.html', {text: 'My text'});
                // callback("https://google.com", { text: "Go To Google", target: '_blank' });
            }else if( meta.filetype === 'media' ){
                hideBodyScrollY();// 隱藏主視窗 ScrollBar
                videoPicker(callback);
                // callback('movie.mp4', {source2: 'alt.ogg', poster: 'image.jpg'});        
            }else if( meta.filetype === 'image' ){
                hideBodyScrollY();// 隱藏主視窗 ScrollBar
                imagePicker(callback);
                // callback('myimage.jpg', {alt: 'My alt text'});
            }else{
                alert("Not supported meta.filetype = " + meta.filetype);
            }
            
            return false;
        }
        
        /**
         * 圖庫選取插入圖片
         * @param {type} callback
         * @returns {undefined}
         */
        function imagePicker(callback){
            // 依視窗大小自動調整
            var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0); 
            w = (w>40)? w-40:w;
            h = (h>80)? h-80:h;
            
            var editId = $('#hiddenEditId').val();
            var fileUrl = SELECT_IMG_DLG_URL + editId;
            // 開啟圖庫選取對話框
            var twin = tinymce.activeEditor.windowManager.open({
                file: fileUrl, // use an absolute path!
                title: '選取插入圖片',
                width: w,
                height: h,
                resizable: 'yes'
            }, {
                oninsert: function (url, info){
                    callback(url, {alt: info});
                }
            });
            
            twin.on('close', function(){
                showBodyScrollY();// 顯示主視窗 ScrollBar
            });
        }
        
        /**
         *  影片庫選取插入影片
         * @param {type} callback
         * @returns {undefined}
         */
        function videoPicker(callback){
            // 依視窗大小自動調整
            var w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            var h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0); 
            w = (w>40)? w-40:w;
            h = (h>80)? h-80:h;
            
            var editId = $('#hiddenEditId').val();
            var fileUrl = SELECT_VIDEO_DLG_URL + editId;
            
            // 開啟圖庫選取對話框
            var twin = tinymce.activeEditor.windowManager.open({
                file: fileUrl, // use an absolute path!
                title: '選取插入影片',
                width: w,
                height: h,
                resizable: 'yes'
            }, {
                oninsert: function (url, info) {
                    callback(url, {alt: info});
                }
            });
            
            twin.on('close', function(){
                showBodyScrollY();// 顯示主視窗 ScrollBar
            });
        }
        
        // 切換至編輯模式
        function showDocDetailArea(xhr, status, args, isRichContent){
            if( afterCallBackHandler(xhr, status, args) ){
                if( isRichContent ){
                    showTinyMCE();// TinyMCE 部分不可用 rendered，需用JS控制 
                    tinyMCE.get('mytextarea').setContent($('#hiddenContents').val());// 設定TinyMCE Content值
                }
            }
        }
        
        // 切換至查詢模式
        function hideDocDetailArea(xhr, status, args){
            if( afterCallBackHandler(xhr, status, args) ){
                // *** oncomplete 之後執行無作用，於 onclick 先執行 ***
                // hideTinyMCE();// TinyMCE 部分不可用 rendered，需用JS控制 
            }
            doResize('dtResult');
        }
        
        // 顯示 RichContent 編輯區塊
        function showTinyMCE(){
            $('#wrapper').show();
        }
        // 隱藏 RichContent 編輯區塊
        function hideTinyMCE(){
            $('#wrapper').hide();
        }
        // TinyMCE 初始後動作
        function afterTinyMCE(){
            // 避免JS執行過慢造成畫面殘留，原wrapper先用CSS影藏；TinyMCE 初始後須恢復正常。
            $('#wrapper').css("height", "auto");
            $('#wrapper').css("overflow-y", "auto");
        }
        
        // 警示 TinyMCE Content 將被清除
        function checkContent(){
            var html = tinyMCE.get('mytextarea').getContent();
            var s = html.indexOf("<body>");
            var e = html.indexOf("</body>");
            html = html.substring(s+6, e-1).trim();
            // alert("checkContent = " + html);
            if( html !== '' ){// TinyMCE 編輯區非空白
                if( !confirm('此動作將清除[自製網頁]輸入內容!\n確定要執行嗎?') ){
                    return false;
                }else{
                    tinyMCE.get('mytextarea').setContent('');
                }
            }
            return true;
        }
        
        // 變更資料類型
        function changeDataType(el){
            if( $(el).val() === 'H' ){// HTML Content
                showTinyMCE();
            }else{
                if( !checkContent() ){// 警示 TinyMCE Content 將被清除
                    $(el).val($('#dataTypeORI').val());// 恢復原值
                    return false;
                }else{
                    hideTinyMCE();
                }
            }
            
            $('#dataTypeORI').val($(el).val());// 變更原值
            return true;
        }
        
        // 儲存前將 TinyMCE 編輯內容，指定給JSF元件傳值
        function preSave(){
            //$('#mytextarea').val(tinyMCE.get('mytextarea').getContent());
            // 過濾已知的[看不見的特殊控制字元 // 0x0C
            var content = tinyMCE.get('mytextarea').getContent();
            var ctrl0 = String.fromCharCode(0xc);
            var myRegExp = new RegExp(ctrl0, 'g');
            //alert(content.length);
            content = content.replace(myRegExp, ""); 
            //alert(content.length);
            $('#mytextarea').val(content);
            return true;
        }
        
        // 開啟真實預覽視窗
        function openPreviewWin(xhr, status, args){
            try{
                if( args.success !== undefined ){
                    if( args.success ){
                        afterSuccess();
                        if( args.pubType !== undefined && args.code !== undefined && args.realType !== undefined ){
                            var url = WEB_PREVIEW_URL+"?pubType="+args.pubType+"&code="+args.code+"&realType="+args.realType;
                            window.open(url);
                        }
                        return true;
                    }
                }
                alert("無法預覽!");
            }catch(err){
                afterError();
                alert("請將畫面提供系統管理人員 ("+ err + "), 以利排除系統問題，謝謝!");
            }
            return false;
        }
        
        // 確定關閉(回查詢頁)
        function confirmClose(){
            if( confirm('您確定要離開文章編輯畫面嗎?\n(若有要保留的修改，請按[取消]，先[儲存]後再離開。)') ){
                hideTinyMCE();
                return true;
            }
            return false;
        }
        //]]>
    </script>
</ui:composition>