<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{memberController.funcTitle}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
            .pgCol1, .pgCol2 {
                vertical-align: top;
                margin: 0;
                border: #0022aa; 
            }
        </style>
        <script type="text/javascript">
            //<![CDATA[
            function openEditOrgsDlg(){
                PF('wvDlgEditOrgs').show();
            }
            function closeEditOrgsDlg(){
                PF('wvDlgEditOrgs').hide();
            }
            function handleAfterOrgsSave(xhr, status, args) {
                //function handleAfterSave() {    
                if( handleCallBack(xhr, status, args) ){
                    PF('wvDlgEditOrgs').hide();
                }
            }
            function gotoUserFactory(userId){
                var param = "?userId="+userId;
                var url = "#{request.contextPath}/faces/admin/userFactory.xhtml" + param;
                self.location.href = url;
            }
            function confirmDisableUser(){
                var msg = '確定要將此帳號設為無效嗎?\n\n'
                        + '若要刪除關聯權限，請勾選上方\n[設定使用者無效時，同時刪除權限關聯] CheckBox。\n\n'
                        + '若要自網頁[保種中心成員]中移除，請勾選上方\n[設定使用者無效時，同時自網頁[保種中心成員]中移除] CheckBox。';
                if( !confirm(msg) ){ return false; }
                return true;
            }
            //]]>
        </script>
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        
        <h:form id="fmMain" prependId="false" >
            <!-- 查詢條件輸入表單 -->
            <p:panel header="#{memberController.funcTitle}" style="overflow-x: scroll;" rendered="#{!memberController.functionDenied}" >
                <h:panelGroup>
                    <!-- BEGIN: 查詢條件區 -->
                    <p:fieldset id="fsQueryConds" legend="#{msg['search.critical']}" collapsed="false"
                                toggleable="true" toggleSpeed="500">
                        <p:panelGrid columns="6" >
                            <p:outputLabel value="帳號或姓名關鍵字：" />
                            <p:inputText id="itKeyword" maxlength="30" size="20" value="#{memberController.criteriaVO.keyword}" />
                            <p:watermark for="itKeyword" value="輸入帳號或姓名關鍵字" />
                            
<!--                            <p:outputLabel value="系統角色：" />
                            <p:selectOneMenu id="somCType" value="#{usersController.criteriaVO.group}" 
                                             filter="true" filterMatchMode="contains"
                                             style="width:400px" >
                                <f:selectItems value="#{usersController.tcGroups}"/>
                            </p:selectOneMenu>
                            <p:spacer width="5px"/>-->

                            <p:spacer width="10" height="5" />
                            <p:selectBooleanCheckbox itemLabel="排除無效" value="#{memberController.criteriaVO.active}" />
                            <p:selectBooleanCheckbox itemLabel="排除系統停用" value="#{memberController.criteriaVO.disabled}" />
                        </p:panelGrid>
                        <p:separator /> 
                        <p:outputPanel id="opQueryBtn" >
                            <p:spacer width="10" height="20" />
                            <!--確定按鈕-->
                            <p:commandButton value="#{msg['button.search']}" icon="ui-icon-search"
                                             action="#{memberController.doQuery()}"
                                             oncomplete="doResize();" 
                                             update="fsResult"/>
                            <p:spacer width="5px"/>
                            <!--清除按鈕-->
                            <p:commandButton value="#{msg['common.button.clear']}" icon="ui-icon ui-icon-cancel"
                                             action="#{memberController.doReset()}" 
                                             update="fsQueryConds fsResult"
                                             />
                            <p:spacer width="10px"/>
                            
                        </p:outputPanel>
                    </p:fieldset>
                    <!-- END 查詢條件區 -->
                    <!-- BEGIN: 查詢結果列表區 -->
                    <p:fieldset id="fsResult" legend="#{msg['search.result']}">
                        
                        <p:commandLink title="匯出EXCEL檔" immediate="true" ajax="false" onclick="setUpBlockUI();" 
                                       rendered="#{memberController.lazyModel!=null}" >
                            <h:graphicImage library="images" name="excel.png" style="border: none; vertical-align: middle; width: 24px; height: 24px" />
                            <p:dataExporter type="xls" target=":fmMain:dtResult" fileName="userList" />
                        </p:commandLink>
                        <h:outputText id="otRowCount" value="(共#{memberController.lazyModel.rowCount}筆)" rendered="#{memberController.lazyModel!=null}" />
                        <p:remoteCommand name="rcGetRowCountAfterFiltered" update=":fmMain:otRowCount" />
                        
                        
                        <!-- 移動查詢結果 -->
                        <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
                        <!--  查詢結果 -->
                        <p:dataTable id="dtResult" var="row"  
                                     value="#{memberController.lazyModel}" lazy="true"
                                     widgetVar="wvDTResult"
                                     filteredValue="#{memberController.filterResultList}"
                                     styleClass="ui-datatable-hor-scroll"
                                     rows="10"
                                     paginator="true" 
                                     rowKey="#{row.id}" >
                            <!-- filter 後變更筆數, 使用 Lazy Loading 不可直接 update 會抓到上次筆數，故用 oncomplete -->
                            <p:ajax event="filter" oncomplete="doResize(); rcGetRowCountAfterFiltered();" /><!-- 調整寬度 for chrome -->
                            <!-- 操作 -->
                            <p:column width="40" style="text-align:center;min-width:40px;" exportable="false" 
                                      rendered="#{memberController.isAdmin}">
                                <f:facet name="header" >
                                    <h:outputLabel value="操作" /><p:spacer width="5" />
                                    <p:commandLink title="新增" 
                                                   actionListener="#{memberController.add()}"
                                                   oncomplete="openEditDlg()" 
                                                   update=":editForm"
                                                   rendered="true" >
                                        <h:graphicImage library="images" name="add.png" styleClass="icons" style="width:22px; height:22px" />
                                    </p:commandLink><p:spacer width="5" />
                                </f:facet>
                                <p:tooltip for="mbOptions" value="操作(#{row.id})(#{row.memberId})"  />
                                <p:menuButton id="mbOptions" value="&nbsp;" >
                                    <p:menuitem value="重設密碼"
                                                onstart="if( !confirm('確定要重設密碼嗎?') ){ return false; }"
                                                actionListener="#{memberController.resetPassword(row)}"
                                                icon="ui-icon-mail-closed"/>  
                                </p:menuButton>
                            </p:column>
                            <p:column sortBy="#{row.loginAccount}" headerText="帳號" exportable="false" 
                                      filterBy="#{row.loginAccount}" width="120" filterStyle="width:80px" style="text-align: center">  
                                <p:commandLink title="編輯" 
                                               actionListener="#{memberController.edit(row)}" 
                                               update=":editForm"
                                               oncomplete="openEditDlg()" 
                                               rendered="#{memberController.isAdmin}">
                                    <h:outputText value="#{row.loginAccount}" style="#{row.disabled?'text-decoration:line-through':''}" />
                                </p:commandLink>
                                <h:outputText value="#{row.loginAccount}" style="#{row.disabled?'text-decoration:line-through':''}" 
                                              rendered="#{!memberController.isAdmin}"/>
                            </p:column>
                            <p:column style="display:none" >  
                                <f:facet name="header" >
                                    <h:outputLabel value="帳號" />
                                </f:facet>
                                <h:outputText value="#{row.loginAccount}" />
                            </p:column>
                            
                            <p:column sortBy="#{row.name}" headerText="姓名" exportable="false" 
                                      filterBy="#{row.name}" width="60" filterStyle="width:60px" style="text-align: center">  
                                <h:outputText value="#{row.name}" style="#{row.disabled?'text-decoration:line-through':''}" />
                            </p:column>
                            <p:column style="display:none"> 
                                <f:facet name="header" >
                                    <h:outputLabel value="姓名" />
                                </f:facet>
                                <h:outputText value="#{row.name}" />
                            </p:column>
                            
                            <p:column sortBy="#{row.phone}" headerText="電話" exportable="false"
                                      filterBy="#{row.phone}" width="100" filterStyle="width:60px" style="text-align: center;min-width:80px;">  
                                <h:outputText value="#{row.phone}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="電話" />
                                </f:facet>
                                <h:outputText value="#{row.phone}" />
                            </p:column>
                            
                            <p:column sortBy="#{row.active}" headerText="有效" exportable="false" style="text-align: center" width="60">  
                                <h:graphicImage library="images" name="check.png" styleClass="icons" rendered="#{row.active}" />
                                <h:graphicImage library="images" name="agt_action_fail.png" styleClass="icons" rendered="#{!row.active}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="有效" />
                                </f:facet>
                                <h:outputText value="#{row.active?'是':'否'}" />
                            </p:column>
                            <p:column sortBy="#{row.disabled}" headerText="系統停用" exportable="false" style="text-align: center" width="80">  
<!--                                <h:graphicImage library="images" name="check.png" styleClass="icons" rendered="#{!row.disabled}" />
                                <h:graphicImage library="images" name="agt_action_fail.png" styleClass="icons" rendered="#{row.disabled}" />-->
                                <h:outputText value="#{row.disabled?'是':'否'}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="系統停用" />
                                </f:facet>
                                <h:outputText value="#{row.disabled?'是':'否'}" />
                            </p:column>
                            
                            <p:column sortBy="#{row.applytime}" headerText="申請時間" exportable="false"
                                      width="140" 
                                      filterBy="#{row.applytime}" style="text-align: center">  
                                <h:outputText value="#{row.applytime}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column style="display:none">  
                                <f:facet name="header" >
                                    <h:outputLabel value="申請時間" />
                                </f:facet>
                                <h:outputText value="#{row.applytime}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>

                            <p:column sortBy="#{row.venderCodes}" headerText="申請供應商代碼" exportable="false"
                                      filterBy="#{row.venderCodes}" filterStyle="width:60px" style="text-align: left;min-width:120px;">  
                                <h:outputText value="#{row.venderCodes}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="申請供應商代碼" />
                                </f:facet>
                                <h:outputText value="#{row.venderCodes}" />
                            </p:column>

<!--                            <p:column sortBy="#{row.applyVenderCode}" headerText="申請供應商代碼" exportable="false"
                                      filterBy="#{row.applyVenderCode}" filterStyle="width:60px" style="text-align: left;min-width:120px;">  
                                <h:outputText value="#{row.applyVenderCode}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="申請供應商代碼" />
                                </f:facet>
                                <h:outputText value="#{row.applyVenderCode}" />
                            </p:column>
                            <p:column sortBy="#{row.applyVenderName}" headerText="申請供應商名稱" exportable="false"
                                      filterBy="#{row.applyVenderName}" filterStyle="width:60px" style="text-align: left;min-width:120px;">  
                                <h:outputText value="#{row.applyVenderName}" />
                            </p:column>
                            <p:column style="display:none">
                                <f:facet name="header" >
                                    <h:outputLabel value="申請供應商名稱" />
                                </f:facet>
                                <h:outputText value="#{row.applyVenderName}" />
                            </p:column>-->
                            
<!--                            <p:column sortBy="#{row.approvetime}" headerText="核准時間" exportable="false"
                                      width="140" 
                                      filterBy="#{row.approvetime}" style="text-align: center">  
                                <h:outputText value="#{row.approvetime}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column style="display:none">  
                                <f:facet name="header" >
                                    <h:outputLabel value="核准時間" />
                                </f:facet>
                                <h:outputText value="#{row.approvetime}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>-->
                            
<!--                            <p:column sortBy="#{row.creator}" headerText="建立人" exportable="false" 
                                      filterBy="#{row.creator}" width="80" filterStyle="width:55px" style="text-align: center">  
                                <h:outputText value="#{row.creator}" />
                            </p:column>
                            <p:column style="display:none">  
                                <f:facet name="header" >
                                    <h:outputLabel value="建立人" />
                                </f:facet>
                                <h:outputText value="#{row.creator}" />
                            </p:column>
                            
                            <p:column sortBy="#{row.createTimestamp}" headerText="建立時間" exportable="false"
                                      width="140" 
                                      filterBy="#{row.createTimestamp}" style="text-align: center">  
                                <h:outputText value="#{row.createTimestamp}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>
                            <p:column style="display:none">  
                                <f:facet name="header" >
                                    <h:outputLabel value="建立時間" />
                                </f:facet>
                                <h:outputText value="#{row.createTimestamp}" >
                                    <f:convertDateTime pattern="#{app.dateTimeFormat}" />
                                </h:outputText>
                            </p:column>-->
                            
                        </p:dataTable>
                        
                    </p:fieldset>
                    <!-- END: 查詢結果列表區 -->
                    
                </h:panelGroup>
            </p:panel>
        </h:form>
        
        <!-- 編輯對話框 -->
        <ui:include src="/member/inc_memberEditDlg.xhtml"></ui:include>
                
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{memberController}"/>
        </ui:include>
        
    </ui:define>
</ui:composition>
