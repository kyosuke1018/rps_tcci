<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{publication.funcTitle}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
            .ui-datatable .ui-column-filter {
                width: 50px;
            }
        </style>
        <script type="text/javascript">
        //<![CDATA[
        $(function () {
            hideTinyMCE();// 預設查詢模式，先隱藏
            initTinyMCE();// 初始 TinyMCE
            afterTinyMCE();// TinyMCE 初始後動作
        });
        //]]>
        </script>
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        <!-- 移動查詢結果 -->
        <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
        
        <h:form id="fmMain" prependId="false" >
            <!-- 查詢條件輸入表單 -->
            <p:panel header="#{publication.funcTitle}" style="overflow-x: scroll;" 
                     rendered="#{!publication.functionDenied and !publication.showDetail}" >
                <!-- 查詢條件設定 -->
                <p:fieldset legend="#{msg['search.critical']}" toggleable="true" collapsed="true" >
                    <p:panelGrid columns="2" >
                        <p:outputLabel value="關鍵字：" styleClass="fieldname" />
                        <h:panelGroup id="pgPubCriteria" >
                            <p:inputText size="30" value="#{publication.criteriaVO.keyword}" />

                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="資料型態：" styleClass="fieldname" />
                            <p:selectOneMenu value="#{publication.criteriaVO.dataType}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{ui.dataTypeOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                           
                            <h:panelGroup>
                                <p:spacer width="10" height="5" />
                                <p:outputLabel value="歸屬資料夾：" styleClass="fieldname" />
                                <p:selectOneMenu value="#{publication.criteriaVO.parent}" >
                                    <f:selectItem itemLabel="==" noSelectionOption="true" />
                                    <f:selectItems value="#{publication.folders}" 
                                                   var="vo" itemValue="#{vo.id}" itemLabel="#{vo.title}" ></f:selectItems>
                                </p:selectOneMenu>
                            </h:panelGroup>
                        </h:panelGroup>
                        
                        <p:outputLabel value="發佈日期：" styleClass="fieldname" />
                        <h:panelGroup id="pgPubCriteria2" >
                            <p:calendar  showOn="button" size="12" maxlength="10" readonlyInput="false" navigator="true"
                                         value="#{publication.criteriaVO.startDate}" 
                                         converterMessage="日期格式錯誤(yyyy/MM/dd)" 
                                         pattern="yyyy/MM/dd"
                                         id="sdt" />
                            <p:watermark for="sdt" value="起" />
                            <p:outputLabel value="~" />
                            <p:calendar  showOn="button" size="12" maxlength="10" readonlyInput="false" navigator="true"
                                         value="#{publication.criteriaVO.endDate}"
                                         converterMessage="日期格式錯誤(yyyy/MM/dd)" 
                                         pattern="yyyy/MM/dd" 
                                         id="edt" />
                            <p:watermark for="edt" value="迄" />

                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="網站語系：" styleClass="fieldname" />
                            <p:selectOneMenu value="#{publication.criteriaVO.lang}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItem itemLabel="跨語系及繁體中文" itemValue="AC" />
                                <f:selectItem itemLabel="跨語系及英文" itemValue="AE" />
                                <f:selectItems value="#{ui.langWebSiteOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                            
                            <p:spacer width="10" height="5" />
                            <p:selectBooleanCheckbox itemLabel="只顯示有加入最新消息" value="#{publication.criteriaVO.news}" /> 
                         </h:panelGroup>
                    </p:panelGrid>

                    <p:separator />
                    <!-- 查詢 -->
                    <p:commandButton icon="ui-icon-search" value="#{msg['button.search']}"
                                     title="#{msg['button.search']}"
                                     actionListener="#{publication.doQuery()}" 
                                     update="listGroup"
                                     oncomplete="doResize('dtResult');" />
                    <p:spacer width="5px"/>
                    <!--清除按鈕-->
                    <p:commandButton value="#{msg['common.button.clear']}"
                                     icon="ui-icon ui-icon-cancel"  
                                     title="#{msg['common.button.clear']}"
                                     actionListener="#{publication.doReset()}"
                                     oncomplete="doResize('dtResult');" 
                                     update="@form"
                                     />
                </p:fieldset>
                
                <!-- 查詢結果 -->
                <p:fieldset legend="#{msg['search.result']}">
                    <h:panelGroup id="listGroup">
                        <!-- 共 ? 筆 -->
                        <h:outputText id="otRowCount" value="(共#{publication.lazyModel.rowCount}筆)" 
                                      rendered="#{not empty publication.lazyModel}" />
                        <p:remoteCommand name="getRowCountAfterFiltered" update=":fmMain:otRowCount" />
                    
                        <p:dataTable id="dtResult" var="row" lazy="true"
                                     style="width:100%" 
                                     widgetVar="wvDTResult"
                                     value="#{publication.lazyModel}" 
                                     filteredValue="#{publication.filterResultList}"
                                     styleClass="ui-datatable-hor-scroll"
                                     paginator="true"
                                     paginatorPosition="bottom"
                                     rows="10"
                                     rowsPerPageTemplate="10,20,30,50" 
                                     >
                            <p:ajax event="filter" oncomplete="getRowCountAfterFiltered();doResize('dtResult');" />
                            <p:ajax event="page" process="@none" immediate="true" oncomplete="doResize('dtResult');" />
                            <p:ajax event="sort" process="@none" immediate="true" oncomplete="doResize('dtResult');" />
                            
                            <f:facet name="header" >
                                <div style="text-align: center">
                                    <p:outputLabel value="查詢結果列表　" />
                                    <!-- 新增 --><!-- 固定網頁只有系統管理人員可新增與變更編號 -->
                                    <p:commandButton id="createButton" icon="ui-icon-plus" 
                                                     rendered="#{(!publication.readOnly) and publication.canAddDoc()}" 
                                                     value="#{msg['common.add']}"
                                                     actionListener="#{publication.prepareCreate()}"
                                                     update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                                     oncomplete="showDocDetailArea(xhr, status, args, #{publication.showRichContent()});"
                                                     />
                                    <h:panelGroup rendered="#{publication.lazyModel!=null and publication.lazyModel.rowCount gt 0}">
                                        <p:spacer width="5"/>
                                        <!-- 匯出 -->
                                        <p:commandButton value="#{msg['common.export']}" 
                                                         icon="ui-icon-print" ajax="false" onclick="setUpBlockUI();"
                                                         actionListener="#{publication.prepareExport()}">
                                            <p:dataExporter type="xls" fileName="application" target=":fmMain:dtResult" 
                                                         postProcessor="#{publication.postProcessXLS}" />
                                        </p:commandButton>
                                    </h:panelGroup>
                                </div>
                            </f:facet>
                            
                            <!-- 操作 -->
                            <p:column headerText="#{msg['table.action']}" 
                                      style="text-align: center;" exportable="false"
                                      width="45">
                                <p:tooltip for="mbOptions" value="操作(#{row.id})" />
                                <p:menuButton id="mbOptions" value="&nbsp;" >
                                    <!-- 編輯 -->
                                    <p:menuitem value="#{publication.readOnly?'檢視':msg['button.edit']}"
                                                actionListener="#{publication.prepareEdit(row.id)}"
                                                update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                                rendered="#{publication.canEditDoc(row)}"
                                                oncomplete="showDocDetailArea(xhr, status, args, #{row.dataType eq 'H'});"
                                                icon="ui-icon-pencil"/>
                                    <!-- 刪除 --><!-- 確定要刪除嗎? -->
                                    <p:menuitem value="#{msg['button.delete']}"
                                                onstart="if( !confirm('確定要刪除嗎?') ){ return false; }"
                                                actionListener="#{publication.deleteDoc(row)}"
                                                rendered="#{publication.canDeleteDoc(row)}"
                                                update=":fmMain:listGroup :fmMain:pgPubCriteria" 
                                                icon="ui-icon-closethick"/>
                                </p:menuButton>
                            </p:column>
                            <!-- 編號 -->
                            <p:column headerText="編號" width="50" sortBy="#{(empty row.code)?row.id:row.code}" style="text-align:center;" >
                                <h:outputText value="#{(empty row.code)?row.id:row.code}" />
                            </p:column>
                            <!-- 狀態 -->
                            <p:column headerText="狀態" width="45" sortBy="#{row.statusName}" >
                                <h:outputText value="#{row.statusName}" 
                                              rendered="#{row.dataType ne 'F'}" 
                                              style="color:#{row.statusEnum.color}" />
                            </p:column>
                            <!-- 類型 -->
                            <p:column headerText="類型" width="70" sortBy="#{row.dataTypeName}" exportable="false" >
                                <h:graphicImage rendered="#{row.dataType eq ui.folderCode}" name="folder.png" library="images" styleClass="icons" />
                                <h:graphicImage rendered="#{row.dataType eq ui.uploadCode}" name="application_get.png" library="images" styleClass="icons" />
                                <h:graphicImage rendered="#{row.dataType eq ui.linkCode}" name="link.png" library="images" styleClass="icons" />
                                <h:graphicImage rendered="#{row.dataType eq ui.htmlCode}" name="html.png" library="images" styleClass="icons" />
                                <h:outputText value="#{row.dataTypeName}" />
                            </p:column>
                            <!-- 類型 -->
                            <p:column headerText="類型" width="60" sortBy="#{row.dataTypeName}" style="display:none;" >
                                <h:outputText value="#{row.dataTypeName}" />
                            </p:column>
                            <!-- 加入最新消息
                            <p:column headerText="加入&lt;br&gt;最新消息" width="60" style="text-align: center;" 
                                      sortBy="#{row.news}" exportable="false">
                                <h:graphicImage library="images" name="check.png"
                                                styleClass="icons" rendered="#{row.news}" />
                            </p:column>
                            <p:column headerText="加入最新消息" width="60" style="display:none;" >
                                <h:outputText value="#{row.news?'是':''}" />
                            </p:column>
                            -->
                            <!-- 所在資料夾 -->
                            <p:column headerText="所在資料夾" width="80" sortBy="#{row.folderTitle}" >
                                <h:outputText value="#{row.folderTitle}" />
                            </p:column>
                            <!-- 發佈日期 -->
                            <p:column headerText="發佈日期" width="70" sortBy="#{row.dataDate}" >
                                <h:outputText value="#{row.dataDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd"/>
                                </h:outputText>
                            </p:column>
                            <!-- 標題 -->
                            <p:column headerText="標題" width="200" sortBy="#{row.title}" >
                                <h:outputText value="#{row.title}" />
                            </p:column>
                            <!-- 大綱 -->
                            <p:column headerText="大綱" width="330" >
                                <h:outputText value="#{row.summary}" />
                            </p:column>
                            
                            <!-- 建立日期時間 -->
                            <p:column headerText="建立日期時間" width="130" sortBy="#{row.createtimestamp}" >
                                <h:outputText value="#{row.createtimestamp}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                </h:outputText>
                            </p:column>
                            <!-- 最後修改人 -->
                            <p:column headerText="最後修改人" width="100" sortBy="#{row.lastUserName}" >
                                <h:outputText value="#{row.lastUserName}" />
                            </p:column>
                            <!-- 最後更改時間 -->
                            <p:column headerText="最後更改時間" width="130" sortBy="#{row.lastUpdateTime}" >
                                <h:outputText value="#{row.lastUpdateTime}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                    </h:panelGroup>
                    
                </p:fieldset>
            </p:panel>
        </h:form>
                
        <!-- 編輯區塊 -->
        <ui:include src="/inc/content/inc_contentEditForm.xhtml">
            <ui:param name="doctype" value="#{publication.type.name}"/>
        </ui:include>
                
        <!-- 相簿選取對話框 -->
        <ui:include src="/inc/content/inc_albumSelectDlg.xhtml">
        </ui:include>
        
        <!-- 影片選取對話框 -->
        <ui:include src="/inc/content/inc_videoSelectDlg.xhtml">
        </ui:include>
                
        <!-- 文章選取對話框 -->
        <ui:include src="/inc/content/inc_docSelectDlg.xhtml">
        </ui:include>
        
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{publication}"/>
        </ui:include>
        
    </ui:define>
</ui:composition>
