<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{tenderMgnController.funcTitle}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
/*            .ui-datatable .ui-column-filter {
                width: 50px;
            }*/
        </style>
        <script type="text/javascript">
        //<![CDATA[
        $(function () {
//            hideTinyMCE();// 預設查詢模式，先隱藏
//            initTinyMCE();// 初始 TinyMCE
//            afterTinyMCE();// TinyMCE 初始後動作
        });
        //]]>
        </script>
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        <!-- 移動查詢結果 -->
        <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
            
        <h:form id="fmMain" prependId="false" >
            <!-- 查詢條件輸入表單 -->
            <p:panel header="#{tenderMgnController.funcTitle}" style="overflow-x: scroll;" 
                     rendered="#{!tenderMgnController.functionDenied and !tenderMgnController.showDetail}" >
                <!-- 查詢條件設定 -->
                <p:fieldset legend="#{msg['search.critical']}" toggleable="true" collapsed="true" >
                    <p:panelGrid columns="2" >
                        <p:outputLabel value="關鍵字：" styleClass="fieldname" />
                        <h:panelGroup id="pgCriteria" >
                            <p:inputText id="itKeyword" size="30" value="#{tenderMgnController.criteriaVO.keyword}" />
                            <p:watermark for="itKeyword" value="輸入編號或標題關鍵字" />
                            
                            <!-- 工廠 -->
                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="廠別：" styleClass="fieldname"/>
                            <p:selectOneMenu value="#{tenderMgnController.criteriaVO.factoryId}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{tenderMgnController.factoryOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                                
                            <!--與廠權限衝突-->
<!--                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="地區：" styleClass="fieldname"/>
                            <p:selectOneMenu value="#{tenderMgnController.criteriaVO.areaId}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{tenderMgnController.areaOptions}" ></f:selectItems>
                            </p:selectOneMenu>-->
                        </h:panelGroup>
                        
                        <p:outputLabel value="決標日期：" styleClass="fieldname" />
                        <h:panelGroup id="pgCriteria2" >
<!--                            <p:calendar  showOn="button" size="12" maxlength="10" readonlyInput="false" navigator="true"
                                         value="#{tenderMgnController.criteriaVO.startCloseDate}" 
                                         converterMessage="日期格式錯誤(yyyy/MM/dd)" 
                                         pattern="yyyy/MM/dd"
                                         id="scdt" />-->
                            <p:calendar id="scdt" value="#{tenderMgnController.criteriaVO.startCloseDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="scdt" value="起" />
                            <p:outputLabel value="~" />
                            <p:calendar id="ecdt" value="#{tenderMgnController.criteriaVO.endCloseDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="ecdt" value="迄" />
                            
                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="評標日期：" styleClass="fieldname" />
                            <p:calendar id="svdt" value="#{tenderMgnController.criteriaVO.startVerifyDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="svdt" value="起" />
                            <p:outputLabel value="~" />
                            <p:calendar id="evdt" value="#{tenderMgnController.criteriaVO.endVerifyDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="evdt" value="迄" />
                            
<!--                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="網站語系：" styleClass="fieldname" />
                            <p:selectOneMenu value="#{tenderMgnController.criteriaVO.lang}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItem itemLabel="跨語系及繁體中文" itemValue="AC" />
                                <f:selectItem itemLabel="跨語系及英文" itemValue="AE" />
                                <f:selectItems value="#{ui.langWebSiteOptions}" ></f:selectItems>
                            </p:selectOneMenu>-->
                         </h:panelGroup>
                        
                        <p:outputLabel value="發佈日期：" styleClass="fieldname" />
                        <h:panelGroup id="pgCriteria3" >
                            <p:calendar id="spdt" value="#{tenderMgnController.criteriaVO.startPublishDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="spdt" value="起" />
                            <p:outputLabel value="~" />
                            <p:calendar id="epdt" value="#{tenderMgnController.criteriaVO.endPublishDate}" pattern="yyyy/MM/dd" mask="true" size="12"/>
                            <p:watermark for="epdt" value="迄" />
                        </h:panelGroup>
                        
                        <p:outputLabel value="分類：" styleClass="fieldname"/>
                        <h:panelGroup id="pgCriteria4" >
                            <p:selectOneMenu value="#{tenderMgnController.criteriaVO.categoryId}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{tenderMgnController.categoryOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                            <p:spacer width="10" height="5" />
                            <p:outputLabel value="招標方式：" styleClass="fieldname"/>
                            <p:selectOneMenu value="#{tenderMgnController.criteriaVO.type}" >
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{tenderMgnController.typeOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                            <p:spacer width="10" height="5" />
                            <p:selectBooleanCheckbox itemLabel="排除2個月前決標案件" value="#{tenderMgnController.criteriaVO.closed}" />
                            <p:spacer width="10" height="5" />
                            <p:selectBooleanCheckbox itemLabel="排除未開始" value="#{tenderMgnController.criteriaVO.active}" />
                        </h:panelGroup>
                    </p:panelGrid>
                    
                     <p:separator />
                    <!-- 查詢 -->
                    <p:commandButton icon="ui-icon-search" value="#{msg['button.search']}"
                                     title="#{msg['button.search']}"
                                     actionListener="#{tenderMgnController.doQuery()}" 
                                     update="listGroup"
                                     oncomplete="doResize('dtResult');" />
                    <p:spacer width="5px"/>
                    <!--清除按鈕-->
                    <p:commandButton value="#{msg['common.button.clear']}"
                                     icon="ui-icon ui-icon-cancel"  
                                     title="#{msg['common.button.clear']}"
                                     actionListener="#{tenderMgnController.doReset()}"
                                     oncomplete="doResize('dtResult');" 
                                     update="@form"
                                     />
                </p:fieldset>
                
                <!-- 查詢結果 -->
                <p:fieldset legend="#{msg['search.result']}">
                    <h:panelGroup id="listGroup">
                        <!-- 共 ? 筆 -->
                        <h:outputText id="otRowCount" value="(共#{tenderMgnController.lazyModel.rowCount}筆)" 
                                      rendered="#{not empty tenderMgnController.lazyModel}" />
                        <p:remoteCommand name="getRowCountAfterFiltered" update=":fmMain:otRowCount" />
                    
                        <p:dataTable id="dtResult" var="row" lazy="true"
                                     style="width:100%" 
                                     widgetVar="wvDTResult"
                                     value="#{tenderMgnController.lazyModel}" 
                                     filteredValue="#{tenderMgnController.filterResultList}"
                                     styleClass="ui-datatable-hor-scroll"
                                     paginator="true"
                                     paginatorPosition="bottom"
                                     rows="10"
                                     rowsPerPageTemplate="10,20,30,50" 
                                     >
                            <p:ajax event="filter" oncomplete="getRowCountAfterFiltered();doResize('dtResult');" />
                            <p:ajax event="page" process="@none" immediate="true" oncomplete="doResize('dtResult');" />
                            <p:ajax event="sort" process="@none" immediate="true" oncomplete="doResize('dtResult');" />
                            <f:facet name="header" >
                                <div style="text-align: center">
                                    <p:outputLabel value="查詢結果列表　" />
                                    <!-- 新增 -->
                                    <p:commandButton id="createButton" icon="ui-icon-plus" 
                                                     rendered="#{(!tenderMgnController.readOnly) and tenderMgnController.canAddDoc()}" 
                                                     value="#{msg['common.add']}"
                                                     actionListener="#{tenderMgnController.prepareCreate()}"
                                                     oncomplete="showDocDetailArea(xhr, status, args);"
                                                     update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn" 
                                                     />
                                    <!--
                                    oncomplete="showDocDetailArea(xhr, status, args, #{publication.showRichContent()});"-->
                                    <h:panelGroup rendered="#{tenderMgnController.lazyModel!=null and tenderMgnController.lazyModel.rowCount gt 0}">
                                        <p:spacer width="5"/>
                                        <!-- 匯出 -->
                                        <p:commandButton value="#{msg['common.export']}" 
                                                         icon="ui-icon-print" ajax="false" onclick="setUpBlockUI();"
                                                         actionListener="#{tenderMgnController.prepareExport()}">
                                            <p:dataExporter type="xls" fileName="application" target=":fmMain:dtResult" 
                                                         postProcessor="#{tenderMgnController.postProcessXLS}" />
                                        </p:commandButton>
                                    </h:panelGroup>
                                </div>
                            </f:facet>
                            
                            <!-- 操作 -->
                            <p:column headerText="#{msg['table.action']}" 
                                      style="text-align: center;" exportable="false"
                                      width="45">
                                 <p:tooltip for="mbOptions" value="操作(#{row.id})" />
                                 <p:menuButton id="mbOptions" value="&nbsp;" >
                                     <!-- 編輯 -->
                                    <p:menuitem value="#{tenderMgnController.readOnly?'檢視':msg['button.edit']}"
                                                actionListener="#{tenderMgnController.prepareEdit(row.id)}"
                                                update=":fmMain :contentEditForm:pgEditDetail :contentEditForm:pgEditDetailBtn"
                                                oncomplete="showDocDetailArea(xhr, status, args);"
                                                rendered="#{tenderMgnController.canEditDoc(row)}"
                                                icon="ui-icon-pencil"/>
                                                <!--
                                                oncomplete="showDocDetailArea(xhr, status, args, #{row.dataType eq 'H'});"-->
                                    <!-- 下架 --><!-- 確定要刪除嗎? -->
                                    <p:menuitem value="下架"
                                                onstart="if( !confirm('確定要下架嗎?') ){ return false; }"
                                                actionListener="#{tenderMgnController.outofDoc(row)}"
                                                rendered="#{tenderMgnController.canOutofDoc(row)}"
                                                update=":fmMain:listGroup :fmMain:pgCriteria" 
                                                icon="ui-icon-closethick"/>            
                                    <!-- 刪除 --><!-- 確定要刪除嗎? -->
                                    <p:menuitem value="#{msg['button.delete']}"
                                                onstart="if( !confirm('確定要刪除嗎?') ){ return false; }"
                                                actionListener="#{tenderMgnController.deleteDoc(row)}"
                                                rendered="#{tenderMgnController.canDeleteDoc(row)}"
                                                update=":fmMain:listGroup :fmMain:pgCriteria" 
                                                icon="ui-icon-closethick"/>
                                    
                                    <p:menuitem value="詢價單查詢"
                                                actionListener="#{tenderMgnController.redirectRfq(row)}"
                                                icon="ui-icon-search"/>
                                    <p:menuitem value="投標查詢"
                                                actionListener="#{tenderMgnController.redirectTender(row)}"
                                                icon="ui-icon-search"/>
                                 </p:menuButton>
                            </p:column>
                            <!-- 編號 -->
                            <p:column headerText="編號" width="70" sortBy="#{(empty row.code)?row.id:row.code}" style="text-align:center;" >
                                <h:outputText value="#{(empty row.code)?row.id:row.code}" />
                            </p:column>
                            <!-- 狀態 -->
                            <p:column headerText="狀態" width="45" sortBy="#{row.statusName}" >
                                <h:outputText value="#{row.statusName}" 
                                              style="color:#{row.statusEnum.color}" />
<!--                                rendered="#{row.dataType ne 'F'}" -->
                            </p:column>
                            <!-- 標題 -->
                            <p:column headerText="標題" width="200" sortBy="#{row.title}" >
                                <h:outputText value="#{row.title}" />
                            </p:column>
                            <p:column headerText="地區" width="70" sortBy="#{row.areaSort}" >
                                <h:outputText value="#{row.areaName}" />
                            </p:column>
                            <p:column headerText="廠別" width="70" sortBy="#{row.factoryName}" >
                                <h:outputText value="#{row.factoryName}" />
                            </p:column>
                            <p:column headerText="招標方式" width="70" sortBy="#{row.type}" >
                                <h:outputText value="#{tenderMgnController.getTypeName(row.type)}" />
                            </p:column>
                            <p:column headerText="分類" width="70" sortBy="#{row.categorySort}" >
                                <h:outputText value="#{row.categoryName}" />
                            </p:column>
                            <p:column headerText="發佈日期" width="100" sortBy="#{row.datadate}" >
                                <h:outputText value="#{row.datadate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <!-- 日期 -->
                            <p:column headerText="發售日期" width="100" sortBy="#{row.esaleDate}" >
                                <h:outputText value="#{row.ssaleDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                                <!--<p:outputLabel value=" ~ " />-->
                                <h:outputText value="#{row.esaleDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="招標日期" width="100" sortBy="#{row.etenderDate}" >
                                <h:outputText value="#{row.stenderDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                                <!--<p:outputLabel value=" ~ " />-->
                                <h:outputText value="#{row.etenderDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="評標日期" width="100" sortBy="#{row.verifyDate}" >
                                <h:outputText value="#{row.verifyDate}">
                                    <!--<f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>-->
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="決標日期" width="100" sortBy="#{row.closeDate}" >
                                <h:outputText value="#{row.closeDate}">
                                    <!--<f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>-->
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <!-- 建立日期時間 -->
                            <p:column headerText="建立日期時間" width="130" sortBy="#{row.createtime}" >
                                <h:outputText value="#{row.createtime}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                </h:outputText>
                            </p:column>
                            <!-- 最後修改人 -->
                            <p:column headerText="最後修改人" width="100" sortBy="#{row.lastUserName}" >
                                <h:outputText value="#{row.lastUserName}" />
                            </p:column>
                            <!-- 最後更改時間 -->
                            <p:column headerText="最後更改時間" width="130" sortBy="#{row.lastUpdateTime}" >
                                <h:outputText value="#{row.lastUpdateTime}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm:ss"/>
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                    </h:panelGroup>    
                </p:fieldset>
            </p:panel>
        </h:form>
           
        <!-- 編輯區塊 -->
<!--        <ui:include src="/tender/inc_tenderEditForm.xhtml">
        </ui:include>-->
        <ui:include src="/tender/inc_tenderEditForm.xhtml"/>
        <!--<ui:include src="/tender/inc_tenderEditForm_1.xhtml"/>-->
        <!--<ui:include src="/tender/inc_tenderEditForm_2.xhtml"/>-->
        <!--<ui:param name="doctype" value="#{publication.type.name}"/>-->
            
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{tenderMgnController}"/>
        </ui:include>
    </ui:define>    
</ui:composition>