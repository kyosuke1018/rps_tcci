<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
    >
    <ui:define name="title">
        <h:outputText value="#{memberFormQuery.funcTitle}" />
    </ui:define>
    <ui:define name="head">
        
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        
        <h:form id="fmMain" prependId="false" >
            <p:panel header="#{memberFormQuery.funcTitle}" style="overflow-x: scroll;" rendered="#{!memberFormQuery.functionDenied}" >
                <h:panelGroup>
                    <!-- BEGIN: 查詢條件區 -->
                    <p:fieldset id="fsQueryConds" legend="#{msg['search.critical']}" collapsed="false"
                                toggleable="true" toggleSpeed="500">
                        <p:panelGrid columns="5" columnClasses="ui-grid-col-1,ui-grid-col-2,ui-grid-col-1,ui-grid-col-2,ui-grid-col-9" layout="grid" styleClass="ui-panelgrid-blank ui-fluid" >
                            <h:outputLabel value="申請單號: "/>
                            <p:inputText value="#{memberFormQuery.criteriaVO.id}"
                                         maxlength="10" size="15"
                                         onblur="trimInput(this)"/>
                            <h:outputLabel value="狀態: "/>
                            <p:selectOneMenu value="#{memberFormQuery.criteriaVO.status}" style="vertical-align: bottom; width:125px">
                                <f:selectItem itemLabel="" itemValue=""/>
                                <f:selectItems value="#{memberFormQuery.statusList}"/>
                            </p:selectOneMenu>
                            <p:spacer height="24" width="1"/>
                            
                            <h:outputLabel value="申請日期: "/>
                            <p:calendar value="#{memberFormQuery.criteriaVO.startAt}" pattern="yyyy/MM/dd" mask="true" size="15"/>
                            <h:outputLabel value=" ~ "/>
                            <p:calendar value="#{memberFormQuery.criteriaVO.endAt}" pattern="yyyy/MM/dd" mask="true" size="15"/>
                            <p:spacer height="24" width="1"/>
                                
                            <h:outputLabel value="廠別: "/>
                            <p:selectOneMenu value="#{memberFormQuery.criteriaVO.factoryId}" style="vertical-align: bottom; width:125px">
                                <f:selectItem itemLabel="==" noSelectionOption="true" />
                                <f:selectItems value="#{memberFormQuery.factoryOptions}" ></f:selectItems>
                            </p:selectOneMenu>
                            
                        </p:panelGrid>
                        <p:separator /> 
                        <p:outputPanel id="opQueryBtn" >
                            <p:spacer width="10" height="20" />
                            <!--確定按鈕-->
                            <p:commandButton value="#{msg['button.search']}" icon="ui-icon-search"
                                             action="#{memberFormQuery.doQuery()}"
                                             oncomplete="doResize();" 
                                             update="fsResult"/>
                            <p:spacer width="5px"/>
                            <!--清除按鈕-->
                            <p:commandButton value="#{msg['common.button.clear']}" icon="ui-icon ui-icon-cancel"
                                             action="#{memberFormQuery.doReset()}" 
                                             update="fsQueryConds fsResult"
                                             />
                            <p:spacer width="10px"/>
                            
                        </p:outputPanel>
                    </p:fieldset>
                    <!-- END 查詢條件區 -->
                    <!-- BEGIN: 查詢結果列表區 -->
                    <p:fieldset id="fsResult" legend="#{msg['search.result']}">
                        <p:commandLink title="匯出EXCEL檔" immediate="true" ajax="false" onclick="setUpBlockUI();" 
                                       rendered="#{memberFormQuery.lazyModel!=null}" >
                            <h:graphicImage library="images" name="excel.png" style="border: none; vertical-align: middle; width: 24px; height: 24px" />
                            <p:dataExporter type="xls" target=":fmMain:dtResult" fileName="memberList" />
                        </p:commandLink>
                        <h:outputText id="otRowCount" value="(共#{memberFormQuery.lazyModel.rowCount}筆)" rendered="#{memberFormQuery.lazyModel!=null}" />
                        <p:remoteCommand name="rcGetRowCountAfterFiltered" update=":fmMain:otRowCount" />
                        
                        
                        <!-- 移動查詢結果 -->
                        <ui:include src="/inc/inc_moveDatatbale.xhtml"></ui:include>
                        <h:outputText value="* 點擊單號檢視申請單。" styleClass="opinfo"/>
                        <!--  查詢結果 -->
                        <p:dataTable id="dtResult" var="row"  
                                     value="#{memberFormQuery.lazyModel}" lazy="true"
                                     widgetVar="wvDTResult"
                                     filteredValue="#{memberFormQuery.filterResultList}"
                                     styleClass="ui-datatable-hor-scroll"
                                     rows="10"
                                     paginator="true" 
                                     reflow="true"
                                     rowKey="#{row.id}" >
                            <!-- filter 後變更筆數, 使用 Lazy Loading 不可直接 update 會抓到上次筆數，故用 oncomplete -->
                            <p:ajax event="filter" oncomplete="doResize(); rcGetRowCountAfterFiltered();" /><!-- 調整寬度 for chrome -->
                            <p:column headerText="單號" sortBy="#{row.id}" width="50">
                                <h:link value="#{row.id}"
                                        target="#{empty target ? '_self':target}"
                                        outcome="formView.xhtml">
                                    <f:param name="id" value="#{row.id}"/>
                                </h:link>
                            </p:column>
                            <p:column headerText="申請類別">
                                <!--<h:outputText value="#{row.type}"/>-->
                                <h:outputText value="#{memberFormQuery.formType(row.type)}"/>
                            </p:column>
                            <p:column headerText="申請人">
                                <h:outputText value="#{row.name}(#{row.email})"/>
                            </p:column>
                            <p:column headerText="廠別" sortBy="#{row.factoryId}">
                                <h:outputText value="#{row.factoryName}"/>
                            </p:column>
                            <p:column headerText="申請供應商代碼" sortBy="#{row.applyVenderCode}">
                                <h:outputText value="#{row.applyVenderCode}"/>
                            </p:column>
                            <p:column headerText="申請供應商名稱">
                                <h:outputText value="#{row.applyVenderName}"/>
                            </p:column>
                            <p:column headerText="公司統編/稅籍編號">
                                <h:outputText value="#{row.idCode}"/>
                            </p:column>
                               
                            <p:column headerText="狀態" sortBy="#{row.status}" width="50">
                                <h:outputText value="#{memberFormQuery.formStatus(row.status)}"/>
                            </p:column>
                            <p:column headerText="申請時間" sortBy="#{row.starttime}">
                                <h:outputText value="#{row.starttime}" 
                                              rendered="#{row.processId != null}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="核准時間" sortBy="#{row.endtime}">
                                <h:outputText value="#{row.endtime}" 
                                              rendered="#{row.processId != null and row.executionstate eq 'COMPLETED'}">
                                    <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                                </h:outputText>
                            </p:column>
                        </p:dataTable>
                    </p:fieldset>
                    <!-- END: 查詢結果列表區 -->
                </h:panelGroup>
            </p:panel>
            
            
        </h:form>
    </ui:define>
                    
</ui:composition>