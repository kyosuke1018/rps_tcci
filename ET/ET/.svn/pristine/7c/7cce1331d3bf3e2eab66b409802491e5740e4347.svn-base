<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{msg['func.name.B12']}" />
    </ui:define>
    <ui:define name="head">
        <style type="text/css">
        </style>
        <script type="text/javascript">
            //<![CDATA[
            $(function () {
                // for datatable resize in chrome 
                doResize();
                $(window).resize(function () {
                    doResize();
                });
            });
            
            function confirmDel(){
                return confirm('您確定要刪除嗎?');
            }
            
            function confirmDoNext(){
                if( confirm("確定要離開目前標案報價畫面?\n(注意:未儲存的資料將遺失!)") ){
                    window.location.href = "quote.xhtml";
                }
                return false;
            }
            
            function afterSaveQuote(xhr, status, args){
                if( afterCallBackHandler(xhr, status, args) ){
                    return;
                }
            }
            
            function afterSendQuote(xhr, status, args){
                if( afterCallBackHandler(xhr, status, args) ){
                    return;
                }
            }
            //]]>
        </script>
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
        
        <h:form id="fmMain" prependId="false" >
            <p:panel header="#{msg['func.name.B12']}" rendered="#{!quote.functionDenied}" >
                <!-- BEGIN : 關聯標案資訊　-->
                <ui:include src="/inc/tender/inc_tenderBasic.xhtml">
                    <ui:param name="controller" value="#{quote}"/>
                </ui:include>
                <!-- END : 關聯標案資訊　-->
                
                <!-- BEGIN : 選取報價提供廠商　-->
                <p:fieldset id="fsVender" legend="報價廠商" toggleable="false" rendered="#{!empty quote.quoteVO}" >
                    <p:panelGrid columns="5" >
                        <p:outputLabel value="選取供應商：" /> 
                        <h:panelGroup>
                            <p:selectOneMenu value="#{quote.quoteVO.rfqVenderId}"  >
                                <f:selectItem itemLabel="選取報價供應商" noSelectionOption="true" />
                                <f:selectItems value="#{quote.venderList}" var="op" itemValue="#{op.rfqVenderId}" itemLabel="#{op.venderLabel}" />
                                
                                <p:ajax listener="#{quote.onChangeVender()}" update=":fmMain" process="@this" oncomplete="doResize();" />
                            </p:selectOneMenu>
                        </h:panelGroup>
                        
                        <p:outputLabel value="報價記錄：" rendered="#{!empty quote.quoteList}" />
                        <h:panelGroup rendered="#{!empty quote.quoteList}" >
                            <p:repeat value="#{quote.quoteList}" var="quo" size="#{quote.quoteList.size()}" step="1" varStatus="status" >
                                <p:commandLink actionListener="#{quote.onSelectQuoteTimes(quo)}" 
                                               update=":pgRfqSrvList" 
                                               process="@this"
                                               oncomplete="scrollY(800)" 
                                               title="查看報價明細" 
                                               styleClass="link" 
                                               >
                                    <i class="fa fa-search fa-1x ps"></i>
                                    <h:outputText value="第#{quo.times}次" />
                                    <h:outputText value="(最終報價)" rendered="#{quo.last}" />
                                </p:commandLink>
                            </p:repeat>
                        </h:panelGroup>
                        
                        <p:commandButton value="新增報價" 
                                         actionListener="#{quote.doNewQuotation()}"
                                         disabled="#{!quote.canNewQuote}" 
                                         update=":fmMain"
                                         />
                    </p:panelGrid>
                    <p:spacer width="3" height="20" />
                    <p:outputLabel value="(需對此標案有投標或被邀標的廠商)" styleClass="info" />
                </p:fieldset>
                <!-- END : 選取報價提供廠商　-->
                
                <!-- BEGIN : 詢價單品項列表　-->
                <p:spacer width="5" height="5" />
                <p:panel id="plRfqInput" header="報價資訊" toggleable="true" 
                         rendered="#{(!empty quote.quoteVO) and (!empty quote.quoteVO.rfqVenderId)}" >
                    <!-- for edit -->
                    <p:panelGrid columns="4" rendered="#{!quote.quoteVO.readonly}" >
                        <p:outputLabel value="報價狀態："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.statusEnum.displayName}" />

                        <p:outputLabel value="報價次數："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.timesLabel}" />
                        
                        <p:outputLabel value="報價日期："  styleClass="fieldname"/>
                        <h:panelGroup>
                            <p:calendar pattern="#{app.dateFormat}" value="#{quote.quoteVO.quotetime}" 
                                        size="10" maxlength="10" showOn="button" 
                                        readonlyInput="false" navigator="true"
                                        converterMessage="報價日期格式錯誤" >
                            </p:calendar>
                        </h:panelGroup>
                        <p:outputLabel value="有效期限：" styleClass="fieldname" />
                        <h:panelGroup>
                            <p:calendar pattern="#{app.dateFormat}" value="#{quote.quoteVO.expiretime}" 
                                        size="10" maxlength="10" showOn="button"
                                        readonlyInput="false" navigator="true"
                                        converterMessage="有效期限格式錯誤" >
                            </p:calendar>
                        </h:panelGroup>

                        <p:outputLabel value="稅別：" styleClass="fieldname"/>
                        <h:panelGroup>
                            <p:selectOneMenu value="#{quote.quoteVO.taxType}" >
                                <f:selectItems value="#{quote.taxTypeList}" var="op" itemValue="#{op.code}" itemLabel="#{op.displayName}" />
                            </p:selectOneMenu>
                        </h:panelGroup>
                        <p:outputLabel value="稅率：" styleClass="fieldname" />
                        <h:panelGroup>
                            <p:selectOneRadio value="#{quote.quoteVO.taxRate}" >
                                <f:selectItems value="#{quote.taxRateOps}" />
                            </p:selectOneRadio>
                        </h:panelGroup>
                        
                        <p:outputLabel value="報價幣別："  styleClass="fieldname"/>
                        <h:panelGroup>
                            <p:selectOneMenu value="#{quote.quoteVO.curQuo}"  >
                                <f:selectItem itemLabel="選取報價幣別" noSelectionOption="true" />
                                <f:selectItems value="#{quote.curList}" var="op" itemValue="#{op.code}" itemLabel="#{op.displayName} (#{op.code})" />
                            </p:selectOneMenu>
                            <p:spacer width="3" height="20" />
                        </h:panelGroup>
                        
                        <p:outputLabel value="備註："  styleClass="fieldname"/>
                        <h:panelGroup>
                            <p:inputTextarea value="#{quote.quoteVO.memo}" rows="3" cols="40" autoResize="true" />
                        </h:panelGroup>
                    </p:panelGrid>

                    <!-- for view -->
                    <p:panelGrid columns="4" rendered="#{quote.quoteVO.readonly}" >
                        <p:outputLabel value="報價狀態："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.statusEnum.displayName}" />

                        <p:outputLabel value="報價次數："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.timesLabel}" />
                        
                        <p:outputLabel value="報價日期："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.quotetime}" >
                            <f:convertDateTime pattern="#{app.dateFormat}"/>
                        </h:outputText>
                        <p:outputLabel value="有效期限：" styleClass="fieldname" />
                        <h:outputText value="#{quote.quoteVO.expiretime}" >
                            <f:convertDateTime pattern="#{app.dateFormat}"/>
                        </h:outputText>

                        <p:outputLabel value="稅別：" styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.taxTypeEnum.displayName}" />

                        <p:outputLabel value="稅率：" styleClass="fieldname" />
                        <h:panelGroup>
                            <h:outputText value="#{quote.quoteVO.taxRate}%" />
                        </h:panelGroup>
                        
                        <p:outputLabel value="報價幣別："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.curQuo}" />
                        
                        <p:outputLabel value="備註："  styleClass="fieldname"/>
                        <h:outputText value="#{quote.quoteVO.memo}" />
                    </p:panelGrid>
                    
                    <p:panelGrid columns="3" >
                        <p:outputLabel value="佐證文件：" styleClass="fieldname"></p:outputLabel>
                        <h:panelGroup id="pgFile" >
                            <div style="max-height:300px; max-width: 600px; overflow-y: auto;" >
                                <p:fileUpload fileUploadListener="#{fileController.handleFileUpload}" 
                                              rendered="#{!quote.quoteVO.readonly}" 
                                              update=":pgFile" 
                                              multiple="true" fileLimit="10" 
                                              allowTypes="/(\.|\/)(pdf|doc|docx|ppt|pptx|xls|xlsx)$/"
                                              fileLimitMessage="一次最多上傳10個檔案"
                                              invalidFileMessage="不支援的檔案格式"
                                              invalidSizeMessage="檔案大小超過限制"
                                              sizeLimit="10485760"
                                              label="選取檔案" cancelLabel="取消" uploadLabel="上傳檔案" />
                            </div>
                            <p:outputLabel rendered="#{!empty fileController.files}"
                                       value="已上傳#{fileController.files.size()}個檔案，請記得確認[儲存]。" styleClass="info" />
                        </h:panelGroup>

                        <h:panelGroup id="pgExistedFiles" >
                            <p:panelGrid columns="2" rendered="#{!empty quote.quoteVO.docs}" >
                                <p:outputLabel value="已儲存檔案：" styleClass="fieldname" />
                                <h:panelGroup id="pgUploadFiles" >
                                    <ui:repeat var="doc" value="#{quote.quoteVO.docs}" varStatus="status">
                                        <p:outputLabel value="#{doc.fileName}" />
                                        <h:commandLink title="下載" actionListener="#{fileController.fetchDocFile(doc)}" >
                                            <h:graphicImage library="images" name="download.png" styleClass="icons" />
                                            <p:fileDownload value="#{fileController.downloadFile}" />
                                        </h:commandLink>
                                        <p:spacer width="2" height="5"/>
                                        <p:commandLink title="刪除" 
                                                       actionListener="#{quote.deleteFile(doc)}"
                                                       update=":fmMain:pgExistedFiles"
                                                       onclick="if( !confirm('您確定要刪除嗎?') ){ return false; }" 
                                                       oncomplete="afterCallBackHandler(xhr, status, args);"
                                                       rendered="#{(!quote.readOnly) and (!empty doc.applicationdata)}" >
                                            <h:graphicImage library="images" name="delete.png" styleClass="icons" />
                                        </p:commandLink>
                                        <p:spacer width="10" height="5"/>
                                    </ui:repeat>
                                </h:panelGroup>
                            </p:panelGrid>
                        </h:panelGroup>
                        
                    </p:panelGrid>
                    
                    <h:panelGroup id="pgRfqItemList" >
                        <hr/>
                        <h:panelGroup id="otRowCount" rendered="#{!empty quote.lazyModel}" >
                            <i class="fa fa-1x fa-arrow-circle-o-right ps" ></i>
                            <p:outputLabel value="詢價單包含品項數：" />
                            <p:outputLabel value="#{quote.lazyModel.rowCount}" styleClass="info" />
                            <br/>
                            <i class="fa fa-1x fa-arrow-circle-o-right ps" ></i>
                            <p:outputLabel value="先選取要報價項目，再輸入[單價]與[可供應數量]。" />
                            <br/>
                            <i class="fa fa-1x fa-arrow-circle-o-right ps" ></i>
                            <p:outputLabel value="服務類項目請點擊" />
                            <i class="fa fa-list fa-1x ps icon-fa" ></i>
                            <p:outputLabel value="圖示，再輸入詳細報價。" />
                        </h:panelGroup>
                        
                        <p:remoteCommand name="getRowCountAfterFiltered" update=":fmMain:otRowCount" />
                        
                        <p:dataTable id="dtRfqItemList" var="row" lazy="true" reflow="true"
                                     widgetVar="wvDtRfqItemList" 
                                     styleClass="ui-datatable-hor-scroll"
                                     scrollable="true" 
                                     paginator="true"
                                     paginatorPosition="bottom"
                                     value="#{quote.lazyModel}"
                                     filteredValue="#{quote.filterResultList}"
                                     rows="10"
                                     rowsPerPageTemplate="5,10,20,30,40,50"
                                     >
                            <p:ajax event="filter" oncomplete="getRowCountAfterFiltered();" />
                            <p:ajax event="page" process="@none" immediate="true" />
                            <p:ajax event="sort" process="@none" immediate="true" />
                            
                            <p:column headerText="選取" width="40" styleClass="tac">
                                <p:selectBooleanCheckbox value="#{row.selected}" 
                                                         disabled="#{quote.quoteVO.readonly or (!empty row.loekz)}" >
                                    <p:ajax listener="#{quote.onSelRfqItem(row)}"
                                            process=":plRfqInput"
                                            update=":plRfqInput" />
                                </p:selectBooleanCheckbox>
                                <h:panelGroup rendered="#{row.srvItem}" > 
                                    <p:spacer width="2" height="2" />
                                    <p:commandLink actionListener="#{quote.onViewRfqSrvItems(row)}" 
                                                   update=":pgRfqSrvList" 
                                                   process="@this"
                                                   oncomplete="scrollY(800)" 
                                                   title="查看服務類項目明細" 
                                                   ><i class="fa fa-list fa-1x"></i>
                                    </p:commandLink>
                                </h:panelGroup>
                            </p:column>
                            
                            <p:column headerText="項次" sortBy="#{row.ebelp}" width="40" styleClass="tar">
                                <h:outputText value="#{row.ebelp}" />
                            </p:column>
                            <p:column headerText="物料" sortBy="#{row.matnrUI}" width="90">
                                <h:outputText value="#{row.matnrUI}" />
                            </p:column>
                            <p:column headerText="短文" sortBy="#{row.txz01}" width="150">
                                <h:outputText value="#{row.txz01}" />
                            </p:column>
                            <p:column headerText="數量" styleClass="tar" width="80">
                                <h:outputText value="#{row.rfqMenge}" />
                            </p:column>
                            <p:column headerText="單位" width="40">
                                <h:outputText value="#{row.meins}" />
                            </p:column>
                            <p:column headerText="計價數量" styleClass="tar" width="80">
                                <h:outputText value="#{row.peinh}" />
                            </p:column>
                            <p:column headerText="單價" styleClass="tac" width="90">
                                <p:inputText value="#{row.netpr}" size="10" 
                                             styleClass="tar" 
                                             readonly="#{quote.quoteVO.readonly}" 
                                             rendered="#{row.selected and (!row.srvItem)}" />
                            </p:column>
                            <p:column headerText="總價" styleClass="tar" width="80">
                                <h:outputText value="#{row.brtwr}" />
                            </p:column>
                            <p:column headerText="可供應數量" styleClass="tac" width="90">
                                <p:inputText value="#{row.menge}" size="10" 
                                             styleClass="tar" 
                                             readonly="#{quote.quoteVO.readonly}" 
                                             rendered="#{row.selected and (!row.srvItem)}" />
                            </p:column>
                            <p:column headerText="交貨日期" styleClass="tac" width="90">
                                <p:calendar id="calEindt" pattern="#{app.dateFormat}" value="#{row.eindt}" 
                                            readonly="#{quote.quoteVO.readonly}" 
                                            rendered="#{row.selected}" 
                                            size="10" maxlength="10" readonlyInput="false"
                                            navigator="true"
                                            converterMessage="交貨日期格式錯誤" >
                                </p:calendar>
                                <!--
                                <h:outputText value="#{row.eindt}" rendered="false" >
                                    <f:convertDateTime pattern="#{app.dateFormat}"/>
                                </h:outputText>
                                -->
                            </p:column>
                            <!--
                            <p:column headerText="工廠" sortBy="#{row.werks}" width="80">
                                <h:outputText value="#{row.werks}" />
                            </p:column>
                            -->
                        </p:dataTable>
                        
                        <!-- RFQ 服務類明細 -->
                        <div id="divTopPgRfqSrvList" ></div>
                        <h:panelGroup id="pgRfqSrvList">
                            <h:panelGroup rendered="#{!empty quote.pmList}">
                                <h:outputText value="#{quote.queryRfqPmMsg}" class="fieldvalue" />
                                <p:spacer width="3" height="20" />
                                <i class="fa fa-1x fa-arrow-circle-o-right ps" ></i>
                                <p:outputLabel value="包含品項數：" />
                                <p:outputLabel value="#{quote.pmList.size()}" />
                            </h:panelGroup>
                            
                            <p:dataTable id="dtRfqSrvList" var="srv" lazy="true" reflow="true" 
                                         rendered="#{!empty quote.pmList}"
                                         widgetVar="wvDtRfqSrvList" 
                                         styleClass="ui-datatable-hor-scroll"
                                         scrollable="true" 
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         value="#{quote.pmList}" 
                                         rows="5"
                                         rowsPerPageTemplate="5,10,20,30,40,50"
                                         >
                                <p:column headerText="服務號碼" width="80">
                                    <h:outputText value="#{srv.extrow}" />
                                </p:column>
                                <p:column headerText="短文">
                                    <h:outputText value="#{srv.ktext1}" />
                                </p:column>
                                <p:column headerText="數量" styleClass="tar" width="80">
                                    <h:outputText value="#{srv.menge}" />
                                </p:column>
                                <p:column headerText="單位" width="80">
                                    <h:outputText value="#{srv.meins}" />
                                </p:column>
                                <p:column headerText="單價" styleClass="tac" width="90">
                                    <p:inputText value="#{srv.tbtwr}" size="10" 
                                                 readonly="#{quote.quoteVO.readonly}" />
                                </p:column>
                                <p:column headerText="總價" styleClass="tar" width="80">
                                    <h:outputText value="#{srv.netwr}" />
                                </p:column>
                                <p:column headerText="幣別" width="80">
                                    <h:outputText value="#{srv.waers}" />
                                </p:column>
                            </p:dataTable>
                            
                            <h:panelGroup styleClass="blockBtnC"  rendered="#{!empty quote.pmList}" >
                                <p:commandButton value="確定明細報價" 
                                                 rendered="#{!quote.quoteVO.readonly}" 
                                                 actionListener="#{quote.onConfirmSrvQuote()}"
                                                 update=":plRfqInput"
                                                 oncomplete="afterSaveQuote(xhr, status, args);" />
                                <p:spacer width="5" height="5" />
                                <p:commandButton value="關閉明細" 
                                                 actionListener="#{quote.onCloseSrvItems()}"
                                                 process="@this"
                                                 update=":pgRfqSrvList"
                                                 oncomplete="afterSaveQuote(xhr, status, args);" />
                            </h:panelGroup>
                        </h:panelGroup>
                    </h:panelGroup>
                </p:panel>
                
                <!-- END : 詢價單品項列表　-->
                
                <h:panelGroup styleClass="blockBtnC" rendered="#{(!empty quote.quoteVO) and (!empty quote.quoteVO.rfqVenderId)}">
                    <p:commandButton value="暫存報價" 
                                     disabled="#{(quote.quoteVO.readonly) or (empty quote.quoteItemList)}" 
                                     actionListener="#{quote.onSaveQuote()}"
                                     update=":fmMain"
                                     oncomplete="afterSaveQuote(xhr, status, args);" />
                    <p:spacer width="5" height="5" />
                    <p:commandButton value="確定送出報價" 
                                     disabled="#{(quote.quoteVO.readonly) or (empty quote.quoteItemList)}" 
                                     actionListener="#{quote.onSendQuote()}"
                                     update=":fmMain"
                                     oncomplete="afterSendQuote(xhr, status, args);" />
                    <p:spacer width="5" height="5" />
                </h:panelGroup>
                
            </p:panel>
        </h:form>
        
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{quote}"/>
        </ui:include>
        
    </ui:define>
</ui:composition>
