<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                >
    <ui:define name="title">
        <h:outputText value="#{groupPermissionController.funcTitle}"/>
    </ui:define>
    <ui:define name="head">
        <style  type="text/css">
        </style>
        <script type="text/javascript">
            //<![CDATA[
            function editUserRole_OK() {
                return true;
            }
            
            function afterSave(xhr, status, args) {
                if( args.success ){
                    afterSuccess();
                }
                
                if( args.msg !== undefined ){
                    alert(args.msg);
                }
            }
            //]]>
        </script>        
    </ui:define>
    <ui:define name="content">
        <!-- 公用訊息區 -->
        <ui:include src="/inc/inc_globalMessage.xhtml"></ui:include>
            
        <h:form id="cform" prependId="false" >  
            <p:panel header="#{groupPermissionController.funcTitle}" rendered="#{!groupPermissionController.functionDenied}" ><!-- 群組功能權限維護 -->
                <p:fieldset id="fsGroup" legend="指定群組">
                    <!-- 選取群組 -->
                    <p:outputLabel value="群組角色：" />
                    <p:selectOneMenu id="somGroup" value="#{groupPermissionController.groupId}"
                                     filter="true" filterMatchMode="contains"
                                     onchange="rcSelectGroup();" > 
                        <f:selectItem itemLabel="== 選擇欲設定的群組 ==" itemValue="0" />
                        <f:selectItems value="#{groupPermissionController.tcGroupList}" var="item"
                                       itemLabel="#{item.code}-#{item.name}" itemValue="#{item.id}"  />
                    </p:selectOneMenu>
                    <p:remoteCommand name="rcSelectGroup" actionListener="#{groupPermissionController.selectGroup()}" 
                                     update="pgMain" />
                                         
                    <p:spacer width="20" />
                    <!--
                    <p:commandLink actionListener="#{ui.init()}" 
                                   title="重載 AppclicationScope 使用者群組資訊" 
                                   oncomplete="alert('已重載完成。');" >
                        <h:graphicImage library="images" name="update.png" styleClass="icons" />重載使用者群組
                    </p:commandLink>
                    -->
                </p:fieldset>
                <!-- BEGIN: 選取功能 -->
                <p:fieldset id="fsFunctions" legend="勾選功能" >
                    <p:outputLabel value="＊功能名稱後方[授權等級]選項，程式有支援的功能才有作用。" styleClass="info" />
                    <p:separator />
                    <!-- div style="width: 100%; height: 280px; overflow: auto;" -->
                    <h:panelGroup id="pgMain">
                        <table rules="rows" width="100%" >
                            <ui:repeat id="mainList" var="main" value="#{groupPermissionController.mainList}" >
                                <tr>
                                    <td  width="150px" class="category" >
                                        <!-- 第一層選單 -->
                                        <p:selectBooleanCheckbox id="cbMain" immediate="true" value="#{groupPermissionController.mainMenuCheckMap[main.id]}" style="vertical-align: middle;">
                                            <p:ajax event="change" immediate="false" listener="#{groupPermissionController.selectMainMenu(main.id)}" update="opSub"/>
                                        </p:selectBooleanCheckbox>
                                        <p:spacer width="3" />
                                        <h:outputText value="#{main.title}" />
                                    </td>
                                    <td>
                                        <p:outputPanel id="opSub" >
                                            <ui:repeat id="subList" var="sub" value="#{groupPermissionController.mainSubMap[main]}" varStatus="status" >
                                                <!-- 子選單 -->
                                                <div>
                                                    <p:selectBooleanCheckbox id="cbSub" immediate="true" value="#{groupPermissionController.subMenuCheckMap[sub.id]}" style="vertical-align: middle;"
                                                                             onchange="selectSubMenu([{name: 'sid', value: '#{sub.id}'}]);" >
                                                    </p:selectBooleanCheckbox>
                                                    <p:spacer width="3" />
                                                    <h:outputText value="#{sub.code}#{sub.title}" style="info" />：
                                                </div>
                                                <!-- 功能 -->
                                                <p:outputPanel id="opFunc" >
                                                    <ui:repeat id="funcList" var="func" value="#{groupPermissionController.subFuncMap[sub]}" varStatus="status">
                                                        <p:spacer height="20" width="50" rendered="#{(status.index) % 3 eq 0}" />
                                                        <p:selectBooleanCheckbox id="cbFunc" immediate="true" value="#{groupPermissionController.functionCheckMap[func.id]}" style="vertical-align: middle;">
                                                        </p:selectBooleanCheckbox>
                                                        <p:spacer width="1" height="1" />
                                                        <h:outputText value="#{func.code}#{func.title}" title="#{func.url}" /><p:spacer width="5" />
                                                        <p:spacer width="1" height="1" />
                                                        <p:selectOneMenu value="#{groupPermissionController.functionAuthMap[func.id]}" >
                                                            <f:selectItems value="#{ui.authLevelOptions}" />
                                                        </p:selectOneMenu>
                                                        <p:spacer width="8" height="5" />
                                                        <!--每3個換行一次-->
                                                        <h:panelGroup rendered="#{(status.index+1) % 3 eq 0}" ><br/></h:panelGroup>
                                                    </ui:repeat>
                                                </p:outputPanel>
                                            </ui:repeat>
                                        </p:outputPanel>
                                    </td>   
                                </tr>
                            </ui:repeat>
                        </table>
                    </h:panelGroup><!-- pgFactory --> 
                    <!-- /div -->
                </p:fieldset>
                <!-- END: 選取功能 -->
                    
                <h:panelGroup style="display:block; text-align:center;">
                    <!-- 確定儲存 -->
                    <p:commandButton id="btnOk"
                                     icon="ui-icon-circle-check"
                                     value="確定"
                                     actionListener="#{groupPermissionController.save}"
                                     oncomplete="afterSave(xhr, status, args);"
                                     update="@form" />
                    <p:spacer width="4" />
                    <!-- 取消 -->
                    <p:commandButton id="btnCancel"
                                     value="取消" type="button"
                                     icon="ui-icon-circle-close" onclick="self.location.reload();"/>
                </h:panelGroup>
            </p:panel>
                
            <!-- 第二層 CheckBox 無法直接觸發 --> 
            <p:remoteCommand name="selectSubMenu" actionListener="#{groupPermissionController.selectSubMenu()}"
                             update=":cform:pgMain"
                             /> 
        </h:form>
            
        <!-- 功能權限檢查對話框 -->
        <ui:include src="/inc/inc_authorizationDlg.xhtml">
            <ui:param name="controller" value="#{groupPermissionController}"/>
        </ui:include>
            
    </ui:define>
</ui:composition>