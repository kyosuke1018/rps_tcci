<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                >
    <p:ajaxStatus widgetVar="ajaxStatus" id="myAjaxStatus" rendered="true" 
                  onstart="beforeAjaxHandler()"
                  onerror="afterAjaxErrorHandler();"
                  onsuccess="afterAjaxSuccessHandler();"
                  />
    <!-- for p:ajaxStatus 使用 -->
    <!-- 處理中 -->
    <p:dialog header="#{msg['common.inProcess']}" 
              widgetVar="ajaxStatusDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="ajax-loader.gif" style="vertical-align:middle;" />
        <p:spacer width="4" />
        <!-- 資料處理中，請稍候... -->
        <h:outputText value="#{msg['common.waitting']}" style="font-size: 16px;"/>
    </p:dialog>
    <!-- for 自訂 BlockUI 時機使用 -->
    <!-- 處理中 -->
    <p:dialog header="#{msg['common.inProcess']}" 
              widgetVar="inProcessDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="ajax-loader.gif" style="vertical-align:middle;" />
        <p:spacer width="4" />
        <!-- 資料處理中，請稍候... -->
        <h:outputText value="#{msg['common.waitting']}" style="font-size: 16px;"/>
    </p:dialog>
    <!-- 處理完成 -->
    <p:dialog header="#{msg['common.finishProcess']}" 
              widgetVar="procSuccessDlg"
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="check.png" />
        <p:spacer width="10" />
        <!-- 已處理完成 -->
        <h:outputText value="#{msg['common.finishProcess2']}。" style="font-size: 14px;"/>
    </p:dialog>
    <!-- 處理失敗 -->
    <p:dialog header="#{msg['common.failProcess']}" 
              widgetVar="procErrorDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="delete.png" />
        <p:spacer width="10" />
        <!-- 處理失敗 -->
        <h:outputText value="#{msg['common.failProcess']}!!!" style="font-size: 14px;"/>
    </p:dialog>
        
    <!-- BEGIN: fro PF 6.X Only --> 
    <p:ajaxExceptionHandler type="javax.faces.application.ViewExpiredException"
                            update="expiredDlg"
                            onexception="PF('wvExpiredDlg').show();" />
    <p:ajaxExceptionHandler type="java.lang.NullPointerException"
                            update="exceptionDlg"
                            onexception="PF('wvExceptionDlg').show();" />
    <!-- 提示視窗 -->      
    <p:dialog id="expiredDlg" header="提示視窗" 
              widgetVar="wvExpiredDlg" modal="true" draggable="true"
              width="450px" >
        <h:form>
            <p:outputPanel>
                <!-- 網頁已過期，請按[F5]鍵重新整理後再試。 -->
                <h:outputText value="#{app.callBackErrorMsg}" styleClass="info" style="font-size:16px;" /><br />
                <br/>
                <!-- (重新整理後仍無法執行，請 Email 此畫面給系統管理員，並告知執行動作，以利儘速為您排除問題，謝謝。) -->
                <h:outputText value="#{app.errorMsg}" /><br/>
                <br/>
                <h:outputText value="#{app.debugHitMsg}" /><br/>
                <p:separator />
                <div align="center">
                    <!-- 回首頁 -->
                    <p:commandButton type="button" ajax="false" value="#{msg['label.gohome']}" onclick="PF('wvExpiredDlg').hide(); goHome();" />
                </div>
            </p:outputPanel>
        </h:form>
    </p:dialog>
    <!-- 警示視窗 -->
    <p:dialog id="exceptionDlg" header="警示視窗" 
              widgetVar="wvExceptionDlg" modal="true" draggable="true" 
              width="450px" >
        <h:form>
            <p:outputPanel>
                <!-- 系統發生錯誤，請 Email 此畫面給系統管理員，並告知執行動作，以利盡速為您排除問題。 -->
                <h:outputText value="#{app.exceptionMsg}" styleClass="info" style="font-size:16px;"/><br />
                <br/>
                <h:outputText value="#{app.debugHitMsg}" /><br/>
                <p:separator />
                <div align="center">
                    <!-- 回首頁 -->
                    <p:commandButton type="button" ajax="false" value="#{msg['label.gohome']}" onclick="PF('wvExceptionDlg').hide(); goHome();" />
                </div>
            </p:outputPanel>
        </h:form>
    </p:dialog>
    <!-- END: fro PF 6.X Only --> 
        
    <script type="text/javascript">
        //<![CDATA[
        var CALL_BACK_NULL_MSG = "#{app.callBackErrorMsg}\n";
        var EXCEPTION_MSG = "#{app.exceptionMsg}\n";
        var ERROR_MSG = "#{app.errorMsg}\n";
        var txt="";
        var DEBUG = true;// for debug only
        
        onerror=handleErr;
        
        function handleErr(msg,url,l){
            txt="";
            if( DEBUG ){
                txt+="There was a javascript error on this page.\n\n";
                txt+="Error: " + msg + "\n";
                txt+="URL: " + url + "\n";
                txt+="Line: " + l + "\n\n";
                txt+="Click OK to continue.\n\n";
            }
            txt+=CALL_BACK_NULL_MSG;
            txt+=ERROR_MSG;
            alert(txt);
            return true;
        }
        
        function alertAjaxErrorMsg(){
            alert(CALL_BACK_NULL_MSG + ERROR_MSG);
        }
        
        function alertErrorMsg(){
            alert(EXCEPTION_MSG);
        }
        
        function viewExpiredError() {
            alert(CALL_BACK_NULL_MSG);
        }
        //]]>
    </script>
    <script type="text/javascript">
        //<![CDATA[
        var ajaxStatusShow = true;
        var prototypeOnly = false;
        
        function enableAjaxBlockUI(enable){
            ajaxStatusShow = enable;
        }
        
        function beforeAjaxHandler(){
            if (ajaxStatusShow){
                PF('ajaxStatusDlg').show();
            }
        }
        function afterAjaxHandler(){
            PF('ajaxStatusDlg').hide();
            ajaxStatusShow = true;
        }
        function afterAjaxSuccessHandler(){
            //alert("afterAjaxSuccessHandler");
            afterAjaxHandler();
        }
        function afterAjaxErrorHandler(){
            //alert("afterAjaxErrorHandler");
            if( prototypeOnly ){ return; }
            afterAjaxHandler();
            alertAjaxErrorMsg();
        }
        
        /**
         * 儲存後處理
         * @param {type} xhr
         * @param {type} status
         * @param {type} args
         * @returns {Boolean}
         */
        function afterCallBackHandler(xhr, status, args) {
            try{
                if( args.success !== undefined ){
                    if( args.success ){
                        afterSuccess();
                        return true;
                    }
                }
                
                if( args.msg !== undefined ){
                    alert(args.msg);
                }
            }catch(err){
                afterError();
                alert("請將畫面提供系統管理人員 ("+ err + "), 以利排除系統問題，謝謝!");
            }
            return false;
        }
        
        /**
         * 處理完成
         */
        function afterSuccess(){
            PF('procSuccessDlg').show();
            setTimeout("PF('procSuccessDlg').hide()", 1000);
        };
        
        /**
         * 處理失敗
         */
        function afterError(){
            PF('procErrorDlg').show();
            setTimeout("PF('procErrorDlg').hide()", 1500);
        };
        
        /**
         * do Block UI
         * @param {type} flag
         * @returns {undefined}
         */
        function blockUI(flag){
            if( flag ){
                PF('inProcessDlg').show();
            }else{
                PF('inProcessDlg').hide();
            }
        }
        
        function waitPrimefacesReady(ms){
            blockUI(true);
            setTimeout('blockUI(false)', ms);
        }
        
        function goHome(){
            window.location.href = "#{ui.contextPath}";
        }
        //]]>
    </script>
</ui:composition>