<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="/templates/generalPageTemplate.xhtml"
                xmlns:c="http://java.sun.com/jsp/jstl/core">
    <ui:define name="title">
        <!--Y14 線上使用者管理-->
       <h:outputText value="#{msg['menu.onlineUserMgm']}"/>
    </ui:define>
    <ui:define name="head">

    </ui:define>
    <ui:define name="content">
        <h:form id="form" prependId="false">
            <h:panelGroup id="messagesGroup">
                <p:messages id="messages" showDetail="false" autoUpdate="true"/> 
                <p:growl id="growl" showDetail="false" sticky="false" autoUpdate="true"/>  
            </h:panelGroup>
            
            <!--模擬帳號測試
            <p:fieldset legend="#{msg['common.simUserTest']}" rendered="true" >
                <p:autoComplete size="30" value="#{switchUserManagedBean.selectedUserTxt}"
                                completeMethod="#{switchUserManagedBean.autoCompleteUserOptions}" 
                                onkeypress="ajaxStatusShow=false" onblur="ajaxStatusShow=true" 
                                onclick=""
                                dropdown="true"
                                >
                </p:autoComplete>
                <p:spacer width="40" height="2"/>
                -模擬帳號-
                <p:commandButton value="#{msg['button.simUser']}" action="#{switchUserManagedBean.switchUser}"/>
            -->
            
            <p:fieldset legend="模擬使用者" rendered="true" collapsed="true" toggleable="true" >
                <h:panelGroup rendered="#{tcSessionController.isUserInRole('ADMINISTRATORS')}">
                    <h:outputText value="未設定SUGUARD!" rendered="#{empty simulateUser.suguardUrl}"/>
                    <h:outputText value="尚未申請權限!" rendered="#{not empty simulateUser.suguardUrl and empty simulateUser.lastForm}"/>
                    <h:outputText value="最新申請單狀態如下:" rendered="#{not empty simulateUser.lastForm}"/>
                    <h:panelGrid columns="2" rendered="#{not empty simulateUser.lastForm}">
                        <h:outputLabel value="申請單ID:"/>
                        <h:panelGroup>
                            <h:outputText value="#{simulateUser.lastForm.id}"/>&nbsp;
                            <p:button value="檢視"
                                      onclick="view('#{simulateUser.lastForm.id}');return false;"/>
                        </h:panelGroup>
                        <h:outputLabel value="系統代碼:"/>
                        <h:outputText value="#{simulateUser.lastForm.systemCode}"/>
                        <h:outputLabel value="申請人:"/>
                        <h:outputText value="#{simulateUser.lastForm.applicant}"/>
                        <h:outputLabel value="模擬帳號:"/>
                        <h:outputText value="#{simulateUser.lastForm.emuAccounts}"/>
                        <h:outputLabel value="申請原因:"/>
                        <h:outputText value="#{simulateUser.lastForm.reason}"/>
                        <h:outputLabel value="申請時間:"/>
                        <h:panelGroup>
                            <h:outputText value="#{simulateUser.lastForm.startTime}">
                                <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                            </h:outputText>
                            <h:outputText value=" ~ "/>
                            <h:outputText value="#{simulateUser.lastForm.endTime}">
                                <f:convertDateTime pattern="yyyy/MM/dd HH:mm"/>
                            </h:outputText>
                            <h:outputText value=" (已逾期)"
                                          style="color: red;"
                                          rendered="#{simulateUser.lastForm.expired}"/>
                        </h:panelGroup>
                        <h:outputLabel value="狀態:"/>
                        <h:panelGroup>
                            <h:outputText value="#{simulateUser.lastForm.status} "/>&nbsp;
                            <p:button value="編輯"
                                      onclick="edit('#{simulateUser.lastForm.id}');return false;"
                                      rendered="#{simulateUser.canDo('EDIT')}"/>
                        </h:panelGroup>
                    </h:panelGrid>
                    <hr/>
                    <h:panelGroup rendered="#{simulateUser.canDo('SIMULATE')}">
                        <h:outputText value="模擬帳號: "/>
                        <p:inputText value="#{simulateUser.emuAccount}"
                                     onblur="trimInputToLower(this)"/>
                        <p:commandButton value="送出"
                                         action="#{simulateUser.doSimulate}"
                                         ajax="false" 
                                         />
                    </h:panelGroup>
                    <p/>
                    <p:button value="新申請"
                              onclick="create();return false;"
                              rendered="#{simulateUser.canDo('CREATE')}"/>                    
                </h:panelGroup>            
                <h:panelGroup rendered="#{not tcSessionController.isUserInRole('ADMINISTRATORS')}">
                    <h:outputText value="無權限"/>
                </h:panelGroup>            
               <script type="text/javascript">
                    function view(id) {
                        window.open('#{simulateUser.suguardUrl}/faces/suform/view.xhtml?id=' + id,
                        'suguard');
                    }
                    function edit(id) {
                        window.open('#{simulateUser.suguardUrl}/faces/suform/edit.xhtml?id=' + id,
                        'suguard');
                    }
                    function create() {
                        window.open('#{simulateUser.suguardUrl}/faces/suform/edit.xhtml?systemCode=#{simulateUser.systemCode}',
                        'suguard');
                    }
                </script>
            </p:fieldset>
            

            <p:separator />
            <p:fieldset legend="線上使用者" toggleable="true" >
                <p:commandLink update=":form:dtOnlineUsers"
                               title="重載線上使用者資訊" 
                               oncomplete="alert('已重載完成。');" >
                    <h:graphicImage library="images" name="update.png" styleClass="icons" />重載線上使用者資訊
                </p:commandLink>
                <p:dataTable id="dtOnlineUsers" value="#{app.onlineUsers}" var="row" rowIndexVar="idx" >
                    <p:column>
                        <f:facet name="header"><h:outputText value="序號" /></f:facet>
                        <h:outputText value="#{idx+1}" />
                    </p:column>
                    <p:column sortBy="#{row.loginAccount}" >
                        <f:facet name="header"><h:outputText value="帳號" /></f:facet>
                        <!--<h:outputText value="#{row.loginAccount}" />-->
                        <p:commandLink  value="#{row.loginAccount}" action="#{switchUserManagedBean.selectOnlineUser(row.loginAccount)}">
                        </p:commandLink>
                    </p:column>
                    <p:column sortBy="#{row.cname}" >
                        <f:facet name="header"><h:outputText value="姓名" /></f:facet>
                        <h:outputText value="#{row.cname}" />
                    </p:column>
                    <p:column sortBy="#{row.email}" >
                        <f:facet name="header"><h:outputText value="Email" /></f:facet>
                        <h:outputText value="#{row.email}" />
                    </p:column>
                </p:dataTable>
                
            </p:fieldset>
            
        </h:form>
    </ui:define>
</ui:composition>
