<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                >
    <p:ajaxStatus widgetVar="ajaxStatus" id="myAjaxStatus" rendered="true"
                  onstart="if (ajaxStatusShow) ajaxStatusDlg.show();"
                  onerror="ajaxStatusDlg.hide();ajaxStatusShow = true;"
                  onsuccess="ajaxStatusDlg.hide();ajaxStatusShow = true;"/>
    <!-- for p:ajaxStatus 使用 -->
    <p:dialog header="處理中" 
              widgetVar="ajaxStatusDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="loading9.gif" />
        <p:spacer width="4" />
        <h:outputText value="資料處理中，請稍候..." style="font-size: 16px;"/>
    </p:dialog>
    <!-- for 自訂 BlockUI 時機使用 -->
    <p:dialog header="處理中" 
              widgetVar="inProcessDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="loading9.gif" />
        <p:spacer width="4" />
        <h:outputText value="資料處理中，請稍候..." style="font-size: 16px;"/>
    </p:dialog>
    <p:dialog header="處理完成" 
              widgetVar="procSuccessDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="check.png" />
        <p:spacer width="10" />
        <h:outputText value="已處理完成。" style="font-size: 14px;"/>
    </p:dialog>
    <p:dialog header="處理失敗" 
              widgetVar="procErrorDlg" 
              modal="true" 
              width="230"
              resizable="false"
              draggable="false" 
              closable="false">
        <h:graphicImage library="images" name="delete.png" />
        <p:spacer width="10" />
        <h:outputText value="處理失敗!!!" style="font-size: 14px;"/>
    </p:dialog>
    <script type="text/javascript">
    //<![CDATA[
    var ajaxStatusShow = true;
    var prototypeOnly = false;
    ajaxStatus.bindCallback('ajaxComplete', function(event, xhr, settings) {
        if( prototypeOnly ){ return; }
        if (typeof(xhr) !== 'undefined' && typeof(xhr.status) !== 'undefined') {
            if (xhr.status === 200){
                onCompleteCheck(xhr, 'success', ''); // has response
            }else{
                onCompleteCheck(xhr, 'error', ''); // no response //logout or session expired.
            }
        }
    });

    /**
     * 儲存後處理
     */
    afterSaveHandler = function(xhr, status, args) {
        try{
            if( args.success !== undefined ){
                if( args.success ){
                    afterSuccess();
                    return true;
                }
            }
            
            if( args.msg !== undefined ){
                alert(args.msg);
            }
        }catch(err){
            afterError();
            alert("請將畫面提供系統管理人員 ("+ err + "), 以利排除系統問題，謝謝!");
        }
        return false;
    };
        
    /**
     * 處理完成
     */
    afterSuccess = function(){
        procSuccessDlg.show();
        setTimeout('procSuccessDlg.hide()', 1000);
    };

    /**
     * 處理失敗
     */
    afterError = function(){
        procErrorDlg.show();
        setTimeout('procErrorDlg.hide()', 1500);
    };
    //]]>
    </script>
</ui:composition>