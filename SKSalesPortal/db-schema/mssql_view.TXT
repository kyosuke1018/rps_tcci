--SK交易明細VIEW銷貨訂單項次重複IDALL
SELECT     TOP (100) PERCENT dbo.ZVBRK.SKSALEID, dbo.ZVBRK.XBLNR, dbo.SK交易明細VIEW銷貨訂單項次重複.訂單項次
FROM         dbo.ZVBRK INNER JOIN
                      dbo.SK交易明細VIEW銷貨訂單項次重複 ON dbo.ZVBRK.XBLNR = dbo.SK交易明細VIEW銷貨訂單項次重複.發票號碼 AND 
                      dbo.ZVBRK.AUPOS = dbo.SK交易明細VIEW銷貨訂單項次重複.訂單項次
WHERE     (dbo.ZVBRK.FKART LIKE N'%zf%')
ORDER BY dbo.ZVBRK.SKSALEID

--SK交易明細VIEW銷貨訂單項次重複
SELECT     TOP (100) PERCENT 發票號碼, 發票日期, 訂單項次, COUNT(訂單項次) AS 次數
FROM         dbo.SK交易VIEW當年
GROUP BY 發票號碼, 發票日期, 訂單項次
HAVING      (COUNT(訂單項次) > 1)

--SK交易VIEW當年
SELECT     TOP (100) PERCENT dbo.ZVBRK.SKSALEID, dbo.ZVBRK.FKART AS 請款類型, dbo.ZVBRK.VBELN AS 請款文件, RTRIM(dbo.ZVBRK.XBLNR) 
                      AS 發票號碼, CASE WHEN PSTYV = 'ZTNN' THEN '' ELSE CONVERT(smalldatetime, LEFT(FKDAT, 4) + '/' + SUBSTRING(FKDAT, 5, 2) 
                      + '/' + SUBSTRING(FKDAT, 7, 2)) END AS 發票日期, SUBSTRING(dbo.ZVBRK.KUNRG, 5, 6) AS 付款人, SUBSTRING(dbo.ZVBRK.KUNAG, 5, 6) AS 買方, 
                      dbo.ZVBRK.NETWR AS 發票金額, dbo.ZVBRK.VKORG AS 銷售組織, dbo.ZVBRK.VTWEG AS 配銷通路, dbo.ZVBRK.AUGDT AS 結清日期, 
                      dbo.ZVBRK.POSNR AS 請款項目, dbo.ZVBRK.UEPOS AS 上層項目, dbo.ZVBRK.VKGRP AS 銷售群組, dbo.ZVBRK.MATNR AS 物料號碼, 
                      dbo.ZVBRK.LGORT AS 儲存地點, dbo.ZVBRK.CHARG AS 批號, dbo.ZVBRK.VRKME AS 銷售單位, dbo.ZVBRK.FKIMG AS 數量, 
                      dbo.ZVBRK.KBETR AS 單價, dbo.ZVBRK.NETWR1 AS 金額, dbo.ZVBRK.PSTYV AS 項目種類, dbo.ZVBRK.NETWR2 AS 溢價折讓金額, 
                      dbo.ZVBRK.MWSBP AS 溢價折讓稅額, dbo.ZVBRK.WAVWR AS 成本, dbo.ZVBRK.AUBEL AS 訂單號碼, dbo.ZVBRK.AUPOS AS 訂單項次, 
                      dbo.ZVBRK.VGBEL2 AS 出貨單號, dbo.ZVBRK.VGPOS AS 出貨項次, dbo.ZVBRK.VBELN2, dbo.ZVBRK.POSNR2 AS 訂單類型, CONVERT(smalldatetime, 
                      LEFT(dbo.ZVBRK.AUDAT, 4) + '/' + SUBSTRING(dbo.ZVBRK.AUDAT, 5, 2) + '/' + SUBSTRING(dbo.ZVBRK.AUDAT, 7, 2)) AS 訂單日期, dbo.ZVBRK.AUART, 
                      dbo.ZVBRK.VGBEL AS 合約號碼, dbo.ZVBRK.PERNR AS 業務代號, dbo.ZVBRK.ERDAT, dbo.SK客戶VIEW.NAME1 AS 付款客戶, 
                      SK客戶VIEW_1.NAME1 AS 買方客戶, dbo.SK物料VIEW.物料英文
FROM         dbo.ZVBRK INNER JOIN
                      dbo.SK客戶VIEW ON dbo.ZVBRK.KUNRG = dbo.SK客戶VIEW.KUNNR INNER JOIN
                      dbo.SK客戶VIEW AS SK客戶VIEW_1 ON dbo.ZVBRK.KUNAG = SK客戶VIEW_1.KUNNR INNER JOIN
                      dbo.SK物料VIEW ON dbo.ZVBRK.MATNR = dbo.SK物料VIEW.物料號碼
WHERE     (CASE WHEN PSTYV = 'ZTNN' THEN '' ELSE CONVERT(smalldatetime, LEFT(FKDAT, 4) + '/' + SUBSTRING(FKDAT, 5, 2) + '/' + SUBSTRING(FKDAT, 7, 2)) 
                      END > '2008/12/31') AND (dbo.ZVBRK.PSTYV = N'TAN') AND (dbo.ZVBRK.FKIMG <> 0)
					  
--SK交易VIEW銷貨
SELECT     SKSALEID, 請款類型, 請款文件, 發票號碼, 發票日期, 付款人, 買方, 發票金額, 銷售組織, 配銷通路, 結清日期, 請款項目, 上層項目, 銷售群組, 物料號碼, 
                      儲存地點, 批號, 銷售單位, 數量, 單價, 金額, 項目種類, ROUND(溢價折讓金額, 0) AS 溢價折讓金額, ROUND(溢價折讓稅額, 0) AS 溢價折讓稅額, 成本, 
                      訂單號碼, 訂單項次, 出貨單號, 出貨項次, VBELN2, 訂單類型, 訂單日期, AUART, 合約號碼, 業務代號, ERDAT, 付款客戶, 買方客戶, 物料英文, 內文, 
                      未稅金額, 稅金
FROM         dbo.SK交易VIEW
WHERE     (LEFT(請款類型, 2) = N'ZF') OR
                      (LEFT(請款類型, 2) = N'ZL')
					  
					  
--SK交易VIEW銷貨合約號碼
SELECT     發票日期, 發票號碼, SUM(金額 - 溢價折讓金額 - 溢價折讓稅額) AS 金額, 銷售群組, 合約號碼
FROM         dbo.SK交易VIEW銷貨
WHERE     (LEFT(合約號碼, 3) = '196')
GROUP BY 發票號碼, 發票日期, 銷售群組, 合約號碼


--SK交易VIEW合約
SELECT     dbo.SK交易VIEW銷貨合約號碼.發票日期, dbo.SK交易VIEW銷貨合約號碼.銷售群組, dbo.SK交易VIEW銷貨合約號碼.發票號碼, 
                      dbo.SK交易VIEW銷貨合約號碼.金額 AS 銷售金額, dbo.SK交易VIEW銷貨合約號碼.合約號碼, 
                      dbo.SK交易VIEW銷貨合約號碼.金額 / dbo.ZVBAK.ZWERT * dbo.ZVBAK.KWERT AS 合約成本
FROM         dbo.SK交易VIEW銷貨合約號碼 INNER JOIN
                      dbo.ZVBAK ON dbo.SK交易VIEW銷貨合約號碼.合約號碼 = dbo.ZVBAK.VBELN