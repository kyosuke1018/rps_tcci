ALTER PROCEDURE [dbo].[SK業績日結SP] 
	@procDate1 smalldatetime,@procDate2 smalldatetime
AS
BEGIN
	SET NOCOUNT ON;
--日結程序--
--刪除溢折重複的資料--
DELETE [SKMIS].[dbo].[SK交易明細VIEW銷貨訂單項次重複ID]
INSERT INTO [SKMIS].[dbo].[SK交易明細VIEW銷貨訂單項次重複ID]
           ([SKSALEID],[XBLNR],訂單項次)
SELECT [SKSALEID],[XBLNR],訂單項次 FROM SK交易明細VIEW銷貨訂單項次重複IDALL
UPDATE ZVBRK SET NETWR2=0, MWSBP=0 WHERE     (SKSALEID IN
                          (SELECT     SKSALEID
                            FROM          dbo.SK交易明細VIEW銷貨訂單項次重複IDnoTOP1))
UPDATE ZVBRK SET NETWR2=0, MWSBP=0 WHERE fkimg=0

--990819  by shvon
--IF 990501後 & RETURN_RATE is null & CHECK_ID is null(表尚未審核) 修改退貨倍數:

declare @sSKSALEID INT,@sMATNR CHAR(18),@sCHARG CHAR(10),@sVGBEL2 CHAR(10),
        @sAUGRU VARCHAR(4),@sCODE1 VARCHAR(4)

set nocount on
declare Cursor1 cursor for
SELECT A.*,CODE1 FROM
(SELECT SKSALEID, 物料號碼,  批號, 出貨單號, 退貨原因
   FROM     SK交易VIEW退貨
 WHERE 發票日期>='20100501'AND 退貨倍數 is null AND 審核人員 is NULL
) A
LEFT JOIN 
(SELECT MATNR,CHARG,VGBEL,CODE1 FROM ZQALS) B
ON A.出貨單號=B.VGBEL AND A.物料號碼=B.MATNR AND A.批號=B.CHARG

open Cursor1
fetch next from  Cursor1 into 
 @sSKSALEID,@sMATNR,@sCHARG,@sVGBEL2,@sAUGRU,@sCODE1
while @@FETCH_STATUS=0
BEGIN
-- IF SD 退貨=501, 502 OR 503 
--    IF QA退貨 IS NULL 則不處理 ELSE
--    IF QA退貨=R01,R02 OR R03 則為1.0 ELSE 為1.5 
-- ELSE 為1.5
  IF (@sAUGRU='501' or @sAUGRU='502' or @sAUGRU='503') 
  BEGIN
     IF @sCODE1 IS NOT NULL 
     BEGIN
        IF (@sCODE1='R01' OR @sCODE1='R02' OR @sCODE1='R03') 
          UPDATE ZVBRK SET RETURN_RATE=1 WHERE SKSALEID=@sSKSALEID
        ELSE
          UPDATE ZVBRK SET RETURN_RATE=1.5 WHERE SKSALEID=@sSKSALEID
     END
  END 
  ELSE --只要不是品質退貨, 不管有沒有驗就給1.5
    UPDATE ZVBRK SET RETURN_RATE=1.5 WHERE SKSALEID=@sSKSALEID

  fetch next from Cursor1 into 
  @sSKSALEID,@sMATNR,@sCHARG,@sVGBEL2,@sAUGRU,@sCODE1
END
select @@CURSOR_ROWS
close Cursor1
deallocate Cursor1

declare @i int, @j int, @tdate char(10)
set @i = 0
set @j = datediff(day,@procDate1,@procDate2)
while (@i<=@j)
begin
	set	@tdate=convert(char(10),DATEADD(day, @i, @procDate1),111)
--刪除存在的資料--
delete SK業績日結 where 工作日期= @tdate 
--新增空白資料欄位--
INSERT INTO [SKMIS].[dbo].[SK業績日結]
           ([工作日期]
           ,[銷售群組]
           ,[發票金額]
           ,[事前溢折]
           ,[退貨金額]
           ,[事後折讓]
           ,[成本]
           ,[預算月額]
           ,[預算日額]
           ,[合約金額],[合約成本],退貨成本,退貨金額2)
SELECT     *
FROM         SK交易VIEW業代銷貨日結及預算及合約
WHERE     (工作日期= @tdate)
ORDER BY 工作日期, 銷售群組
--去除NULL欄位--
        update SK業績日結 set 發票金額=0 where 發票金額 is null AND (工作日期= @tdate) 
        update SK業績日結 set 事前溢折=0 where 事前溢折 is null AND (工作日期= @tdate) 
        update SK業績日結 set 退貨金額=0 where 退貨金額 is null AND (工作日期= @tdate) 
        update SK業績日結 set 事後折讓=0 where 事後折讓 is null AND (工作日期= @tdate) 
        update SK業績日結 set 成本=0     where 成本     is null AND (工作日期= @tdate) 
        update SK業績日結 set 預算月額=0 where 預算月額 is null AND (工作日期= @tdate) 
        update SK業績日結 set 預算日額=0 where 預算日額 is null AND (工作日期= @tdate) 
        update SK業績日結 set 合約金額=0 where 合約金額 is null AND (工作日期= @tdate) 
        update SK業績日結 set 合約成本=0 where 合約成本 is null AND (工作日期= @tdate) 
        update SK業績日結 set 退貨成本=0 where 退貨成本 is null AND (工作日期= @tdate) 
        update SK業績日結 set 退貨金額2=0 where 退貨金額2 is null AND (工作日期= @tdate) 
--刪除NULL日期--
        delete SK業績日結 where 發票金額=0 and [事前溢折]=0 and [退貨金額]=0 and [事後折讓]=0 and [銷售淨額]=0 and [未稅淨額]=0 and [合約金額]=0
--計算資料欄位--
        update SK業績日結 set 銷售淨額=發票金額-事前溢折-退貨金額-事後折讓 where (工作日期= @tdate) 
        update SK業績日結 set 未稅淨額=銷售淨額 WHERE (工作日期= @tdate)  and 銷售淨額<>0
        update SK業績日結 set 毛利率=(未稅淨額-成本+退貨成本)/未稅淨額 WHERE (工作日期= @tdate)  and 未稅淨額<>0
        update SK業績日結 set 月達成率=(未稅淨額)/預算月額 WHERE (工作日期= @tdate)  and 預算月額<>0
        update SK業績日結 set 日達成率=(未稅淨額)/預算日額 WHERE (工作日期= @tdate)  and 預算日額<>0
        
   set @i = @i + 1
end

END
