<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://java.sun.com/jsf/facelets"
                xmlns:f="http://java.sun.com/jsf/core"
                xmlns:h="http://java.sun.com/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                template="../templates/generalPageTemplate.xhtml">
    <ui:define name="title">
        #{msg['menu.sales.quotation.query']}
    </ui:define>    
    <ui:define name="content">
        <h:form prependId="false">
            <p:panel header="#{msg['menu.sales.quotation.query']}">
                <p:fieldset legend="#{msg['common.fieldset.criteria']}:">
                    <h:panelGrid columns="4" width="100%">
                        <h:outputLabel value="#{msg['quotation.area']}:"
                                       for="area"/>
                        <h:selectOneMenu id="area"
                                         value="#{queryQuotation.condition.area}">
                            <f:selectItem itemValue="#{null}"
                                          itemLabel=""/>
                            <f:selectItems value="#{queryQuotation.areaList}"
                                           var="area"
                                           itemValue="#{area}"
                                           itemLabel="#{area}#{queryQuotation.getAreaName(area)}"/>
                        </h:selectOneMenu>

                        <h:outputLabel for="customer_code" 
                                       value="#{msg['customer.code']}:"
                                       />
                        <h:panelGroup id="customerGroup">
                            <p:autoComplete id="customer_code" 
                                            value="#{selectCustomerController.selectedCustomer}"
                                            var="code"
                                            itemLabel="#{code}"
                                            itemValue="#{code}"
                                            completeMethod="#{queryCriteriaController.completeCustomer}"
                                            maxResults="10"
                                            >
                                <p:column style="width: 100%">
                                    #{code} - #{selectCustomerController.getCustomerName(code)}
                                </p:column>
                                <p:ajax event="itemSelect" 
                                        listener="#{selectCustomerController.handleSelect}"
                                        update="customer_code customer_name messages growl"
                                        />
                            </p:autoComplete>
                            <p:spacer width="5px"/>
                            <p:commandButton action="#{queryCriteriaController.initCustomerDialog}"
                                             oncomplete="PF('selectCustomerDlg').show();"
                                             immediate="true"
                                             value="..."
                                             update="customerCode customerName customerSearchResult"/>
                            <h:outputLabel id="customer_name" 
                                           value="#{selectCustomerController.name}"/> 
                        </h:panelGroup>

                        <h:outputLabel for="salesGroup" value="#{msg['sales.group']}:" 
                                       style="margin-right: 10px" />
                        <h:panelGroup>
                            <h:selectOneMenu id="salesGroup" value="#{queryCriteriaController.filter.sales}" 
                                             converter="skSalesMemberConverter"
                                             disabled="#{!queryCriteriaController.salesSelectable}">
                                <f:selectItem itemValue="#{null}"
                                              itemLabel=""/>
                                <f:selectItems value="#{queryCriteriaController.salesList}" var="sales" 
                                               itemLabel="#{sales.code} (#{sales.member.displayIdentifier})" 
                                               itemValue="#{sales}"/>  
                                <p:ajax global="false"/>
                            </h:selectOneMenu>
                            <h:inputHidden binding="#{queryCriteriaController.initSalesDefaultBlankHidden}"/>
                        </h:panelGroup>

                        <h:outputLabel value="#{msg['quotation.date']}:" 
                                       for="orderEntryDate"/>
                        <h:panelGroup id="orderEntryDate">
                            <p:calendar value="#{queryQuotation.condition.beginDate}"
                                        showOn="button"
                                        pattern="yyyy/MM/dd"
                                        navigator="true"
                                        size="12"
                                        converterMessage="#{msg['quotation.date.from.incorrectFormat']}"
                                        />
                            ~
                            <p:calendar value="#{queryQuotation.condition.endDate}"
                                        showOn="button"
                                        pattern="yyyy/MM/dd"
                                        navigator="true"
                                        size="12"
                                        converterMessage="#{msg['quotation.date.to.incorrectFormat']}"
                                        />
                        </h:panelGroup>

                        <h:outputLabel value="#{msg['quotation.status']}:" for="status"/>
                        <h:selectOneMenu id="status"
                                         value="#{queryQuotation.condition.master.status}">
                            <f:selectItem itemValue="#{null}"
                                          itemLabel=""/>
                            <f:selectItems value="#{queryQuotation.statusList}"
                                           var="status"
                                           itemLabel="#{status.displayName}"
                                           itemValue="#{status}"
                                           />
                        </h:selectOneMenu>

                        <h:outputLabel value="#{msg['quotation.productNumber']}:"
                                       for="productNumber"/>
                        <p:inputText id="productNumber"
                                     value="#{queryQuotation.condition.detail.productNumber}"/>

                        <h:outputLabel value="#{msg['quotation.id']}:"
                                       for="id"/>
                        <p:inputText id="id" 
                                     value="#{queryQuotation.condition.master.id}"/>

                        <h:outputLabel value="#{msg['quotation.quotationNo']}:"
                                       for="quotationNo"/>
                        <p:inputText id="quotationNo"
                                     value="#{queryQuotation.condition.master.quotationNo}"/>
                    </h:panelGrid>

                    <h:panelGroup>
                        <p:commandButton value="#{msg['button.search']}" 
                                         icon="ui-icon-search"
                                         action="#{queryQuotation.query}" 
                                         update="searchResult customer_name reprotButtonGroup closeButtonGroup :messages :growl" />
                        <h:panelGroup id="closeButtonGroup">
                            <p:spacer width="10px"
                                      rendered="#{queryQuotation.items.size()>0 and (facesContext.externalContext.isUserInRole('Administrators') || facesContext.externalContext.isUserInRole('Assistant'))}"/>
                            <p:commandButton id="closeButton"
                                             icon="ui-icon-flag" 
                                             value="#{msg['button.finish']}"
                                             ajax="false"
                                             onclick="return confirm('#{msg['quotation.confirmClose']}')"
                                             action="#{queryQuotation.close}"
                                             rendered="#{queryQuotation.items.size()>0 and (facesContext.externalContext.isUserInRole('Administrators') || facesContext.externalContext.isUserInRole('Assistant'))}"
                                             />
                        </h:panelGroup>
                        <p:spacer width="10px"/>
                        <h:panelGroup id="reprotButtonGroup">
                            <p:commandButton id="reportButton"
                                             icon="ui-icon-disk" 
                                             value="#{msg['button.print']}"
                                             ajax="false"
                                             action="#{queryQuotation.exportExcel}"
                                             rendered="#{queryQuotation.items.size()>0}"
                                             />
                        </h:panelGroup>
                    </h:panelGroup>                        
                </p:fieldset>
                <p:fieldset id="searchResult" legend="#{msg['common.fieldset.result']}:">
                    <div style="overflow-y: hidden; overflow-x: scroll; width: 100%">

                        <p:dataTable value="#{queryQuotation.items}"
                                     var="masterVO"
                                     paginator="true"
                                     rows="10">
                            <p:column style="width:16px; text-align: center;">
                                <f:facet name="header">
                                    <h:selectBooleanCheckbox value="#{queryQuotation.selectAll}">
                                        <p:ajax listener="#{queryQuotation.changeSelectAll}"
                                                update="searchResult"/>
                                    </h:selectBooleanCheckbox>
                                </f:facet>
                                <h:selectBooleanCheckbox value="#{masterVO.selected}"/>
                                <p:rowToggler/>
                            </p:column>
                            <p:column headerText="#{msg['quotation.id']}" sortBy="#{masterVO.master.id}">
                                <h:outputText value="#{masterVO.master.id}"/>
                            </p:column>
                            <p:column headerText="#{msg['quotation.date']}" sortBy="#{masterVO.master.quotationDate}">
                                <h:outputText value="#{masterVO.master.quotationDate}">
                                    <f:convertDateTime pattern="yyyy/MM/dd"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="#{msg['sales.group']}"
                                      sortBy="#{queryQuotation.getSalesMember(masterVO.master.customer.sapid)}"
                                      style="white-space: nowrap;">
                                <h:outputText value="#{queryQuotation.getSalesMember(masterVO.master.customer.sapid)}"/>
                            </p:column>
                            <p:column style="white-space: nowrap;" sortBy="#{masterVO.master.customer.displayIdentifier}">
                                <f:facet name="header">
                                    <h:outputText value="#{msg['customer']}"/>
                                    <br/>
                                    <h:outputText value="#{msg['quotation.consignee']}"/>
                                </f:facet>
                                <h:outputText value="#{masterVO.master.customer.displayIdentifier}"
                                              style="font-size: 11px;"
                                              />
                                <br/>
                                <h:outputText value="#{masterVO.master.consignee.displayIdentifier}"
                                              style="font-size: 11px;"
                                              />
                            </p:column>
                            <p:column headerText="#{msg['quotation.poNo']}" sortBy="#{masterVO.master.poNo}">
                                <h:outputText value="#{masterVO.master.poNo}"/>
                            </p:column>
                            <p:column>
                                <f:facet name="header">
                                    <h:outputText value="#{msg['quotation.amount']}"/>
                                    <br/>
                                    <h:outputText value="#{msg['premium.discount']}"/>
                                    <br/>
                                    <h:outputText value="#{msg['quotation.totalAmount']}"/>
                                </f:facet>
                                <h:outputText value="#{masterVO.master.amount}"
                                              style="float: right;">
                                    <f:convertNumber pattern="#,###"/>
                                </h:outputText>
                                <br/>
                                <h:outputText value="#{masterVO.master.premiumDiscount}"
                                              style="float: right;">
                                    <f:convertNumber pattern="#,###"/>
                                </h:outputText>
                                <br/>
                                <h:outputText value="#{masterVO.master.totalAmount}"
                                              style="float: right;">
                                    <f:convertNumber pattern="#,###"/>
                                </h:outputText>

                            </p:column>
                            <p:column headerText="#{msg['quotation.status']}" sortBy="#{masterVO.master.status.displayName}">
                                <h:panelGroup>
                                    <h:outputText value="#{masterVO.master.status.displayName}"
                                                  rendered="#{not queryQuotation.isErrorMessageRendered(masterVO)}"/>
                                    <h:outputText value="#{masterVO.master.status.displayName}"
                                                  title="#{masterVO.master.errorMessage}"
                                                  rendered="#{queryQuotation.isErrorMessageRendered(masterVO)}"/>
                                    <p:spacer width="5px"/>
                                    <h:graphicImage library="images" name="comment.jpg"
                                                    title="#{queryQuotation.getComments(masterVO)}"
                                                    rendered="#{masterVO.master.reviewHistoryCollection ne null and masterVO.master.reviewHistoryCollection.size() ne 0}"/>
                                </h:panelGroup>
                            </p:column>
                            <p:column headerText="#{msg['quotation.quotationNo']}" sortBy="#{masterVO.master.quotationNo}">
                                <h:outputText value="#{masterVO.master.quotationNo}"/>
                            </p:column>
                            <p:column headerText="#{msg['common.label.action']}"
                                      style="width: 100px; white-space: nowrap;">
                                <p:commandButton icon="ui-icon-check"
                                                 title="#{msg['button.review']}"
                                                 oncomplete="PF('reviewOrderDialogVar').show()"
                                                 action="#{queryQuotation.prepareReview(masterVO)}"
                                                 rendered="#{queryQuotation.salesManager || facesContext.externalContext.isUserInRole('Administrators')}"
                                                 update="reviewOrderForm detailForm"/>
                                <p:spacer width="5px"
                                          rendered="#{masterVO.master.status ne 'CLOSED' and masterVO.master.status ne 'REJECT' and (facesContext.externalContext.isUserInRole('Administrators') || facesContext.externalContext.isUserInRole('Assistant'))}"/>
                                <p:commandButton icon="ui-icon-flag"
                                                 title="#{msg['button.finish']}"
                                                 onclick="return confirm('#{msg['quotation.confirmClose']}')"
                                                 action="#{queryQuotation.close(masterVO)}"
                                                 rendered="#{masterVO.master.status ne 'CLOSED' and masterVO.master.status ne 'REJECT' and (facesContext.externalContext.isUserInRole('Administrators') || facesContext.externalContext.isUserInRole('Assistant'))}"/>
                                <p:spacer width="5px"
                                          rendered="#{queryQuotation.canEdit(masterVO)}"/>
                                <p:commandButton icon="ui-icon-pencil"
                                                 title="#{msg['button.edit']}"
                                                 action="#{queryQuotation.edit(masterVO)}"
                                                 rendered="#{queryQuotation.canEdit(masterVO)}"
                                                 update="searchResult"/>
                                <p:spacer width="5px"
                                          rendered="#{queryQuotation.canEdit(masterVO)}"/>
                                <p:commandButton icon="ui-icon-trash"
                                                 title="#{msg['button.delete']}"
                                                 onclick="return confirm('#{msg['common.msg.confirmDelete']}');"
                                                 action="#{queryQuotation.remove(masterVO)}"
                                                 rendered="#{queryQuotation.canEdit(masterVO)}"
                                                 update="searchResult"/>
                            </p:column>
                            <p:rowExpansion>
                                <ui:include src="quotationDetailList.xhtml">
                                    <ui:param name="dataList" value="#{masterVO.detailVOList}"/>
                                </ui:include>
                                <br />
                                <p:fieldset legend="#{msg['quotation.remark']}"
                                            rendered="#{masterVO.master.remark.length() > 0 
                                                        or masterVO.master.remark1.length() > 0
                                                        or masterVO.master.remark2.length() > 0
                                                        or masterVO.master.remark3.length() > 0}"
                                            style="text-align: left; width: 850px;">
                                    <h:panelGroup rendered="#{masterVO.master.remark1 ne null and masterVO.master.remark1.length()>0}">
                                        <h:outputText value="#{queryQuotation.getRemark(masterVO.master.remark1)}"/>
                                        <br/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{masterVO.master.remark2 ne null and masterVO.master.remark2.length()>0}">
                                        <h:outputText value="#{queryQuotation.getRemark(masterVO.master.remark2)}"/>
                                        <br/>
                                    </h:panelGroup>
                                    <h:panelGroup rendered="#{masterVO.master.remark3 ne null and masterVO.master.remark3.length()>0}">
                                        <h:outputText value="#{queryQuotation.getRemark(masterVO.master.remark3)}"/>
                                        <br/>
                                    </h:panelGroup>
                                    <h:outputText value="#{masterVO.master.remark}"
                                                  rendered="#{masterVO.master.remark ne null and masterVO.master.remark.length()>0}"/>
                                </p:fieldset>
                                <p:fieldset legend="#{msg['quotation.note']}"
                                            rendered="#{masterVO.master.note.length()>0}"
                                            style="text-align: left; width: 850px;">
                                    <h:outputText value="#{masterVO.master.note}"/>
                                </p:fieldset>       
                            </p:rowExpansion>
                        </p:dataTable>
                    </div>

                </p:fieldset>
            </p:panel>    
        </h:form>
        <ui:include src="../jsff/selectCustomerDlg.xhtml">
            <ui:param name="customerCodeId" value=":customer_code"/>
            <ui:param name="customerNameId" value=":customer_name"/>
        </ui:include>
        <ui:include src="../jsff/ajaxStatusDlg.xhtml"/>
        <ui:include src="reviewQuotationDialog.xhtml"/>
        <ui:include src="detailDialog.xhtml"/>
        <ui:include src="transactionDialog.xhtml"/>
    </ui:define>    
</ui:composition>