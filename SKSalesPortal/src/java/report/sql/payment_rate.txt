select sapid
, ar_amount
, premium_discount
, sales_return
, sales_discount
, payment_amount
, payment_rate
, case 
  when payment_rate>=0.7 then 1.3 
  when payment_rate>=0.6 then 1.2 
  when payment_rate>=0.5 then 1.1 
  when payment_rate>=0.4 then 1.0 
  when payment_rate>=0.3 then 0.7 
  else 0 
  end as weight 
from
(select sapid
, ar_amount
, premium_discount
, sales_return
, sales_discount
, payment_amount
, case (ar_amount - premium_discount - sales_return - sales_discount)
  when 0 then 0
  else round(cast(payment_amount as decimal(15,6))/(ar_amount - premium_discount - sales_return - sales_discount), 4)
  end as payment_rate
from
(select sapid
, sum(ar_amount) as ar_amount
, sum(-premium_discount) as premium_discount
, sum(-sales_return) as sales_return
, sum(-sales_discount) as sales_discount
, sum(-payment_amount) as payment_amount
from
(select 
	t.kunnr as customer_number
,	t.zuonr as order_number
,	t.sgtxt as invoice_number
,   (case 
    when z.vkgrp is null then t.hzuon
    else z.vkgrp
    end) as sapid
,	t.amt_a as ar_amount
,	t.amt_b as premium_discount
,	t.amt_c as sales_return
,	t.amt_d as sales_discount
,	t.amt_e as payment_amount
from ZBSEGCOLL t
left join zkna1 z on t.hzuon=z.kunnr) i1
group by sapid) i2
) i3